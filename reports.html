<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯„æµ‹æŠ¥å‘Š - EvalLite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="css/common.css">
</head>
<body class="min-h-screen">
    <!-- å¯¼èˆªæ å°†é€šè¿‡JSæ’å…¥ -->

    <!-- Main Content -->
    <main class="page-container">
        <!-- Header -->
        <div class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="page-title">è¯„æµ‹æŠ¥å‘Š</h1>
                <p class="page-subtitle">æŸ¥çœ‹å’Œç®¡ç†è¯„æµ‹ç»“æœ</p>
            </div>
            <button id="clearAllBtn" class="px-4 py-2 text-red-600 border border-red-300 rounded-xl hover:bg-red-50 transition font-medium">
                æ¸…ç©ºå†å²
            </button>
        </div>

        <!-- History List -->
        <div id="historyList" class="space-y-4">
            <!-- History items will be rendered here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="glass-effect rounded-2xl p-12 text-center shadow-lg" style="display: none;">
            <div class="text-6xl mb-4">ğŸ“Š</div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">æš‚æ— è¯„æµ‹è®°å½•</h3>
            <p class="text-gray-500 mb-6">æ‰§è¡Œæµ‹è¯•åä¼šè‡ªåŠ¨ä¿å­˜åœ¨è¿™é‡Œ</p>
            <a href="test.html" class="btn-primary px-6 py-3 rounded-xl font-medium inline-block shadow-lg text-white">
                å¼€å§‹æµ‹è¯•
            </a>
        </div>
    </main>

    <!-- Report Detail Modal -->
    <div id="reportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto" style="backdrop-filter: blur(5px);">
        <div class="min-h-screen px-4 py-8">
            <div class="glass-effect rounded-2xl max-w-7xl mx-auto shadow-2xl">
                <div class="p-8">
                    <!-- Modal Header -->
                    <div class="flex justify-between items-start mb-6">
                        <h2 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                            è¯„æµ‹æŠ¥å‘Šè¯¦æƒ…
                        </h2>
                        <button id="closeReportModal" class="text-gray-500 hover:text-gray-700 text-2xl">
                            Ã—
                        </button>
                    </div>

                    <!-- Tab Navigation -->
                    <div class="flex gap-2 mb-6 border-b border-gray-200">
                        <button class="tab-btn active" data-tab="output">æ¨¡å‹è¾“å‡º</button>
                        <button class="tab-btn" data-tab="scoring">è¯„åˆ†</button>
                        <button class="tab-btn" data-tab="visualization">å¯è§†åŒ–åˆ†æ</button>
                        <button class="tab-btn" data-tab="export">å¯¼å‡º</button>
                    </div>

                    <!-- Tab Content -->
                    <div id="tabContent">
                        <!-- Content will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .tab-btn {
            padding: 0.75rem 1.5rem;
            border-bottom: 2px solid transparent;
            color: #6b7280;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #7c3aed;
            border-bottom-color: #7c3aed;
        }

        .tab-btn:hover {
            color: #7c3aed;
        }

        .weight-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, #e5e7eb, #7c3aed);
            outline: none;
            -webkit-appearance: none;
        }

        .weight-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #7c3aed;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .weight-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #7c3aed;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>

    <!-- Scripts -->
    <script type="module">
        import { renderNavbar, showToast } from './js/navbar.js';
        import { Storage } from './js/storage.js';
        import { callModelAPI } from './js/apiClient.js';

        // æ¸²æŸ“å¯¼èˆªæ 
        renderNavbar('history');

        class ReportManager {
            constructor() {
                this.currentReport = null;
                this.currentTab = 'output';
                this.currentStep = 1; // è¯„åˆ†æ­¥éª¤ï¼š1-4
                this.radarChart = null;
                this.costChart = null;
                this.aiScoringReasons = {}; // å­˜å‚¨AIè¯„åˆ†ç†ç”±
                this.attachEventListeners();

                // æ£€æŸ¥URLå‚æ•°,çœ‹æ˜¯å¦ä»history.htmlç›´æ¥è·³è½¬
                const urlParams = new URLSearchParams(window.location.search);
                const reportId = urlParams.get('id');
                const mode = urlParams.get('mode');
                const tab = urlParams.get('tab');

                if (reportId) {
                    // ç›´æ¥æ‰“å¼€æŒ‡å®šæŠ¥å‘Š
                    const history = Storage.getHistory();
                    const reportIndex = history.findIndex(h => h.id === reportId);
                    if (reportIndex !== -1) {
                        this.currentReport = { ...history[reportIndex], index: reportIndex };
                        const modal = document.getElementById('reportModal');
                        modal.classList.remove('hidden');
                        modal.style.display = 'block';
                        this.switchTab(tab || (mode === 'evaluation' ? 'scoring' : 'output'));
                    }
                } else {
                    this.renderHistoryList();
                }
            }

            attachEventListeners() {
                document.getElementById('clearAllBtn').addEventListener('click', () => this.clearAll());
                document.getElementById('closeReportModal').addEventListener('click', () => this.closeReportModal());

                // Tabåˆ‡æ¢
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });

                // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
                document.getElementById('reportModal').addEventListener('click', (e) => {
                    if (e.target.id === 'reportModal') this.closeReportModal();
                });
            }

            renderHistoryList() {
                const history = Storage.getHistory();
                const listContainer = document.getElementById('historyList');
                const emptyState = document.getElementById('emptyState');

                if (history.length === 0) {
                    listContainer.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }

                listContainer.style.display = 'block';
                emptyState.style.display = 'none';

                listContainer.innerHTML = history.map((item, index) => {
                    const modeText = item.mode === 'single' ? 'å•ä»»åŠ¡' : 'ä»»åŠ¡é“¾';
                    const taskName = item.mode === 'single' ? item.task.name : `ä»»åŠ¡é“¾ (${item.chain.length}ä¸ªä»»åŠ¡)`;
                    const modelsCount = item.results.length;
                    const hasEvaluation = item.evaluation && item.evaluation.scores;

                    return `
                        <div class="glass-effect rounded-2xl p-6 shadow-lg card">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="px-3 py-1 text-xs font-medium text-white rounded-full bg-gradient-to-r ${item.mode === 'single' ? 'from-blue-400 to-blue-600' : 'from-purple-400 to-purple-600'}">
                                            ${modeText}
                                        </span>
                                        <h3 class="text-lg font-semibold text-gray-800">${this.escapeHtml(taskName)}</h3>
                                        ${hasEvaluation ? '<span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded">å·²è¯„åˆ†</span>' : ''}
                                    </div>
                                    <p class="text-sm text-gray-500">${this.formatDate(item.timestamp)}</p>
                                    <p class="text-sm text-gray-600 mt-2">æµ‹è¯•äº† ${modelsCount} ä¸ªæ¨¡å‹</p>
                                </div>
                                <div class="flex gap-2">
                                    <button
                                        onclick="window.reportManager.viewReport(${index})"
                                        class="px-4 py-2 text-blue-600 hover:bg-blue-50 rounded-lg transition font-medium text-sm">
                                        æŸ¥çœ‹è¯¦æƒ…
                                    </button>
                                    <button
                                        onclick="window.reportManager.deleteReport(${index})"
                                        class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition font-medium text-sm">
                                        åˆ é™¤
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            viewReport(index) {
                const history = Storage.getHistory();
                this.currentReport = { ...history[index], index };

                const modal = document.getElementById('reportModal');
                modal.classList.remove('hidden');
                modal.style.display = 'block';

                this.switchTab('output');
            }

            switchTab(tabName) {
                this.currentTab = tabName;

                // æ›´æ–°TabæŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabName);
                });

                // æ¸²æŸ“å¯¹åº”å†…å®¹
                const content = document.getElementById('tabContent');
                switch(tabName) {
                    case 'output':
                        content.innerHTML = this.renderOutputTab();
                        break;
                    case 'scoring':
                        content.innerHTML = this.renderScoringTab();
                        this.attachScoringEventListeners();
                        break;
                    case 'visualization':
                        content.innerHTML = this.renderVisualizationTab();
                        setTimeout(() => this.renderCharts(), 100);
                        break;
                    case 'export':
                        content.innerHTML = this.renderExportTab();
                        this.attachExportEventListeners();
                        break;
                }
            }

            renderOutputTab() {
                if (!this.currentReport) return '';

                const { mode, task, results } = this.currentReport;

                if (mode === 'single') {
                    return `
                        <div class="space-y-4">
                            <div class="p-4 bg-blue-50 rounded-xl border border-blue-200">
                                <h3 class="font-semibold text-blue-900 mb-2">ä»»åŠ¡ä¿¡æ¯</h3>
                                <p class="text-sm text-blue-800 mb-1"><strong>ä»»åŠ¡åç§°:</strong> ${this.escapeHtml(task.name)}</p>
                                ${task.systemPrompt ? `<p class="text-sm text-blue-800 mb-1"><strong>System Prompt:</strong> ${this.escapeHtml(task.systemPrompt)}</p>` : ''}
                                <p class="text-sm text-blue-800"><strong>User Prompt:</strong> ${this.escapeHtml(task.userPrompt)}</p>
                            </div>

                            ${results.map(modelResult => {
                                const { model, executions } = modelResult;
                                const exec = executions[0];

                                // è®¡ç®—æˆæœ¬
                                const pricing = Storage.getModelPricing(model);
                                const cost = pricing && exec.tokensUsed
                                    ? Storage.calculateCost(exec.tokensUsed / 2, exec.tokensUsed / 2, pricing)
                                    : 0;

                                return `
                                    <div class="bg-white border-2 border-gray-200 rounded-xl p-4">
                                        <div class="flex justify-between items-start mb-3">
                                            <div>
                                                <h4 class="font-semibold text-gray-800">${model.modelName}</h4>
                                                <p class="text-sm text-gray-600">${model.provider}</p>
                                            </div>
                                            <div class="text-right text-sm">
                                                <p class="text-gray-600">è€—æ—¶: ${exec.responseTime}ms</p>
                                                <p class="text-gray-500">Tokens: ${exec.tokensUsed}</p>
                                                ${cost > 0 ? `<p class="text-green-600">æˆæœ¬: $${cost.toFixed(6)}</p>` : ''}
                                            </div>
                                        </div>

                                        ${exec.success ? `
                                            <div class="bg-gray-50 p-3 rounded border border-gray-200">
                                                <p class="text-gray-800 text-sm whitespace-pre-wrap">${this.escapeHtml(exec.content)}</p>
                                            </div>
                                        ` : `
                                            <div class="bg-red-50 p-3 rounded border border-red-200">
                                                <p class="text-red-600 text-sm">âŒ ${this.escapeHtml(exec.error)}</p>
                                            </div>
                                        `}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }

                return '<p class="text-gray-500">ä»»åŠ¡é“¾æ¨¡å¼æš‚ä¸æ”¯æŒè¯¦ç»†è¯„æµ‹</p>';
            }

            renderScoringTab() {
                return `
                    <div class="space-y-6">
                        <!-- Step Navigator -->
                        ${this.renderStepNavigator()}

                        <!-- Step Content -->
                        <div id="stepContent">
                            ${this.renderCurrentStep()}
                        </div>
                    </div>
                `;
            }

            renderStepNavigator() {
                const steps = [
                    { num: 1, name: 'é€‰æ‹©æ¨¡æ¿', icon: 'ğŸ“‹' },
                    { num: 2, name: 'AIé…ç½®', icon: 'ğŸ¤–' },
                    { num: 3, name: 'æ‰§è¡Œè¯„åˆ†', icon: 'âœï¸' },
                    { num: 4, name: 'æƒé‡è®¡ç®—', icon: 'ğŸ“Š' }
                ];

                return `
                    <div class="flex items-center justify-between bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-4 border-2 border-purple-200">
                        ${steps.map((step, idx) => `
                            <div class="flex items-center ${idx < steps.length - 1 ? 'flex-1' : ''}">
                                <button
                                    onclick="window.reportManager.goToStep(${step.num})"
                                    class="flex flex-col items-center gap-1 px-4 py-2 rounded-lg transition ${
                                        this.currentStep === step.num
                                            ? 'bg-purple-600 text-white shadow-lg'
                                            : this.currentStep > step.num
                                                ? 'bg-green-100 text-green-700 hover:bg-green-200'
                                                : 'bg-white text-gray-500 hover:bg-gray-100'
                                    }">
                                    <span class="text-2xl">${step.icon}</span>
                                    <span class="text-xs font-medium">${step.num}. ${step.name}</span>
                                    ${this.currentStep > step.num ? '<span class="text-xs">âœ“</span>' : ''}
                                </button>
                                ${idx < steps.length - 1 ? '<div class="flex-1 h-0.5 bg-gray-300 mx-2"></div>' : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            renderCurrentStep() {
                switch(this.currentStep) {
                    case 1: return this.renderStep1();
                    case 2: return this.renderStep2();
                    case 3: return this.renderStep3();
                    case 4: return this.renderStep4();
                    default: return this.renderStep1();
                }
            }

            goToStep(stepNum) {
                this.currentStep = stepNum;
                const stepContent = document.getElementById('stepContent');
                if (stepContent) {
                    stepContent.innerHTML = this.renderCurrentStep();
                    this.attachStepEventListeners();
                }
                // æ›´æ–°æ­¥éª¤å¯¼èˆªå™¨
                const navContainer = stepContent.previousElementSibling;
                if (navContainer) {
                    navContainer.outerHTML = this.renderStepNavigator();
                }
            }

            renderStep1() {
                const templates = Storage.getEvaluationTemplates();
                const evaluation = this.currentReport.evaluation || {};

                return `
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-800">æ­¥éª¤ 1ï¼šé€‰æ‹©è¯„æµ‹æ¨¡æ¿</h3>

                        <div class="p-6 bg-white rounded-xl border-2 border-gray-200">
                            <label class="block text-sm font-semibold text-gray-800 mb-3">ä»è¯„æµ‹é…ç½®ä¸­é€‰æ‹©æ¨¡æ¿</label>
                            <select id="templateSelect" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                <option value="">è¯·é€‰æ‹©è¯„æµ‹æ¨¡æ¿...</option>
                                ${templates.map(t => `
                                    <option value="${t.id}" ${evaluation.templateId === t.id ? 'selected' : ''}>
                                        ${this.escapeHtml(t.name)}
                                    </option>
                                `).join('')}
                            </select>

                            <div id="templatePreview" class="mt-4" style="display: none;">
                                <!-- æ¨¡æ¿é¢„è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                            </div>
                        </div>

                        <div class="flex justify-end gap-3">
                            <button id="step1NextBtn" class="px-6 py-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700 font-medium shadow-lg" disabled>
                                ä¸‹ä¸€æ­¥ï¼šé…ç½®AIè¯„åˆ† â†’
                            </button>
                        </div>
                    </div>
                `;
            }

            renderStep2() {
                const evaluation = this.currentReport.evaluation || {};
                const models = Storage.getModels();

                // è·å–å½“å‰é€‰æ‹©çš„æ¨¡æ¿
                const templateId = evaluation.templateId;
                const template = templateId ? Storage.getEvaluationTemplate(templateId) : null;

                return `
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-800">æ­¥éª¤ 2ï¼šé…ç½®AIè¯„åˆ†ï¼ˆå¯é€‰ï¼‰</h3>

                        <div class="p-6 bg-white rounded-xl border-2 border-gray-200 space-y-4">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="enableAIScoring" class="w-5 h-5 text-purple-600" ${evaluation.aiEnabled ? 'checked' : ''}>
                                <span class="text-sm font-semibold">å¯ç”¨AIè‡ªåŠ¨è¯„åˆ†</span>
                            </label>

                            <div id="aiConfigPanel" class="space-y-4" style="display: ${evaluation.aiEnabled ? 'block' : 'none'};">
                                <!-- å‚è€ƒç­”æ¡ˆ -->
                                <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">
                                        ğŸ“‹ å‚è€ƒç­”æ¡ˆ <span class="text-xs font-normal text-red-600">*å¿…å¡«</span>
                                    </label>
                                    <textarea
                                        id="referenceAnswerInput"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 resize-none"
                                        rows="5"
                                        placeholder="è¯·è¾“å…¥ä»»åŠ¡çš„æ ‡å‡†ç­”æ¡ˆæˆ–æœŸæœ›è¾“å‡º...

ç¤ºä¾‹ï¼š
- ç¿»è¯‘ä»»åŠ¡ï¼šè¾“å…¥æ ‡å‡†è¯‘æ–‡
- ä»£ç ä»»åŠ¡ï¼šè¾“å…¥æ­£ç¡®çš„ä»£ç å®ç°
- å†™ä½œä»»åŠ¡ï¼šè¾“å…¥é«˜è´¨é‡èŒƒæ–‡"
                                    >${this.escapeHtml(evaluation.referenceAnswer || '')}</textarea>
                                    <p class="text-xs text-gray-600 mt-2">ğŸ’¡ AIè¯„åˆ†å°†å‚è€ƒæ­¤ç­”æ¡ˆè¿›è¡Œæ‰“åˆ†ï¼Œç­”æ¡ˆè¶Šè¯¦ç»†ï¼Œè¯„åˆ†è¶Šå‡†ç¡®</p>
                                </div>

                                <!-- è¯„å§”æ¨¡å‹ -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">é€‰æ‹©è¯„å§”æ¨¡å‹</label>
                                    <select id="judgeModelSelect" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <option value="">è¯·é€‰æ‹©...</option>
                                        ${models.map(m => `
                                            <option value="${m.id}" ${evaluation.judgeModelId === m.id ? 'selected' : ''}>
                                                ${m.modelName} (${m.provider})
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <!-- AIè¯„åˆ†Promptï¼ˆé¢„å¡«ï¼Œå¯ç¼–è¾‘ï¼‰ -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">
                                        AIè¯„åˆ†Promptæ¨¡æ¿
                                        <span class="text-xs font-normal text-gray-600">ï¼ˆå·²é¢„å¡«ï¼Œå¯æ ¹æ®éœ€æ±‚ä¿®æ”¹ï¼‰</span>
                                    </label>
                                    <textarea
                                        id="aiPromptTemplate"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 resize-none font-mono text-xs"
                                        rows="12"
                                    >${this.getDefaultAIPrompt(template)}</textarea>
                                    <p class="text-xs text-gray-500 mt-2">
                                        ğŸ’¡ å¯ç”¨å˜é‡ï¼š{task_description}, {reference_answer}, {model_output}, {dimensions_list}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between gap-3">
                            <button onclick="window.reportManager.goToStep(1)" class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 font-medium">
                                â† ä¸Šä¸€æ­¥
                            </button>
                            <button id="step2NextBtn" class="px-6 py-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700 font-medium shadow-lg">
                                ä¸‹ä¸€æ­¥ï¼šå¼€å§‹è¯„åˆ† â†’
                            </button>
                        </div>
                    </div>
                `;
            }

            getDefaultAIPrompt(template) {
                // ç”Ÿæˆç»´åº¦åˆ—è¡¨æ–‡æœ¬
                const dimensions = template ? template.dimensions.map((d, i) =>
                    `${i+1}. ${d.name} (${d.scoreRange.min}-${d.scoreRange.max}åˆ†)${d.description ? ': ' + d.description : ''}`
                ).join('\n') : '';

                // ç”ŸæˆJSONæ ¼å¼ç¤ºä¾‹ - ä½¿ç”¨ç»´åº¦çš„çœŸå®åç§°ä½œä¸ºé”®
                const jsonExample = template ?
                    '{\n' +
                    template.dimensions.map(d => `  "${d.name}": ${d.scoreRange.max}`).join(',\n') +
                    ',\n  "reasoning": "ç®€è¦è¯´æ˜è¯„åˆ†ç†ç”±ï¼ˆ50å­—ä»¥å†…ï¼‰"\n}'
                    :
                    '{\n  "dimension_1": score1,\n  "dimension_2": score2,\n  "reasoning": "ç®€è¦è¯´æ˜è¯„åˆ†ç†ç”±ï¼ˆ50å­—ä»¥å†…ï¼‰"\n}';

                return `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„AIæ¨¡å‹è¯„æµ‹ä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹æ ‡å‡†å¯¹æ¨¡å‹è¾“å‡ºè¿›è¡Œå¤šç»´åº¦è¯„åˆ†ã€‚

ã€ä»»åŠ¡æè¿°ã€‘
{task_description}

ã€å‚è€ƒç­”æ¡ˆã€‘
{reference_answer}

ã€æ¨¡å‹è¾“å‡ºã€‘
{model_output}

ã€è¯„åˆ†ç»´åº¦ã€‘
${dimensions || '{dimensions_list}'}

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¿”å›è¯„åˆ†ç»“æœï¼ˆ**å¿…é¡»ä½¿ç”¨ç»´åº¦åç§°ä½œä¸ºé”®**ï¼‰ï¼š
${jsonExample}

è¯„åˆ†è¦æ±‚ï¼š
1. å®¢è§‚å…¬æ­£ï¼ŒåŸºäºå‚è€ƒç­”æ¡ˆå’Œä»»åŠ¡è¦æ±‚
2. æ¯ä¸ªç»´åº¦ç‹¬ç«‹è¯„åˆ†
3. åˆ†æ•°å¿…é¡»åœ¨è§„å®šèŒƒå›´å†…
4. æä¾›ç®€çŸ­çš„è¯„åˆ†ç†ç”±
5. **é‡è¦**: JSONçš„é”®å¿…é¡»æ˜¯ç»´åº¦åç§°ï¼ˆå¦‚ä¸Šé¢ç¤ºä¾‹æ‰€ç¤ºï¼‰ï¼Œä¸è¦ä½¿ç”¨dimension_1ã€dimension_2ç­‰å ä½ç¬¦`;
            }

            renderStep3() {
                const evaluation = this.currentReport.evaluation || {};
                const templateId = evaluation.templateId;

                if (!templateId) {
                    return `<div class="text-center py-12">
                        <p class="text-gray-600">è¯·å…ˆå®Œæˆæ­¥éª¤1ï¼šé€‰æ‹©è¯„æµ‹æ¨¡æ¿</p>
                        <button onclick="window.reportManager.goToStep(1)" class="mt-4 btn-primary px-6 py-3 rounded-xl">
                            è¿”å›æ­¥éª¤1
                        </button>
                    </div>`;
                }

                const template = Storage.getEvaluationTemplate(templateId);
                const scores = evaluation.scores || {};

                // æ”¶é›†æ‰€æœ‰éœ€è¦è¯„åˆ†çš„æ‰§è¡Œé¡¹ï¼ˆexecutionsæˆ–stepsï¼‰
                const scoringItems = this.collectScoringItems();
                const totalItems = scoringItems.length;
                const totalCells = totalItems * template.dimensions.length;

                // è®¡ç®—è¯„åˆ†è¿›åº¦ï¼ˆåŸºäºexecutionId/stepIdï¼‰
                let scoredItems = 0;
                let scoredCells = 0;
                scoringItems.forEach(item => {
                    const itemScores = scores[item.id] || {};
                    const scoredDims = template.dimensions.filter(dim => itemScores[dim.id]).length;
                    scoredCells += scoredDims;
                    if (scoredDims === template.dimensions.length) {
                        scoredItems++;
                    }
                });

                return `
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-800">æ­¥éª¤ 3ï¼šæ‰§è¡Œè¯„åˆ†</h3>
                            <div class="text-sm text-gray-600">
                                è¿›åº¦: ${scoredItems}/${totalItems} è¾“å‡ºå·²è¯„åˆ†
                                <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-700 rounded">${(scoredCells/totalCells*100).toFixed(0)}%</span>
                            </div>
                        </div>

                        ${evaluation.aiEnabled ? `
                            <div class="p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border-2 border-blue-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-semibold text-gray-800 mb-1">ğŸ¤– AIæ‰¹é‡è¯„åˆ†</p>
                                        <p class="text-xs text-gray-600">å¯¹æ‰€æœ‰æœªè¯„åˆ†çš„è¾“å‡ºè¿›è¡ŒAIè‡ªåŠ¨è¯„åˆ†</p>
                                    </div>
                                    <button onclick="window.reportManager.batchAIScoringStep3()"
                                        class="px-6 py-2 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg hover:from-blue-600 hover:to-purple-600 font-medium shadow-lg">
                                        ğŸš€ æ‰¹é‡AIè¯„åˆ†
                                    </button>
                                </div>
                            </div>
                        ` : ''}

                        <!-- æŒ‰æ¨¡å‹åˆ†ç»„æ˜¾ç¤ºè¯„åˆ†é¡¹ -->
                        <div class="space-y-4">
                            ${this.renderScoringItemsByModel(scoringItems, template, scores, evaluation)}
                        </div>

                        <div class="flex justify-between gap-3">
                            <button onclick="window.reportManager.goToStep(2)" class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 font-medium">
                                â† ä¸Šä¸€æ­¥
                            </button>
                            <button id="step3NextBtn" class="px-6 py-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700 font-medium shadow-lg">
                                ä¸‹ä¸€æ­¥ï¼šé…ç½®æƒé‡ â†’
                            </button>
                        </div>
                    </div>
                `;
            }

            // æ”¶é›†æ‰€æœ‰éœ€è¦è¯„åˆ†çš„é¡¹ç›®ï¼ˆexecutionsæˆ–stepsï¼‰
            collectScoringItems() {
                const items = [];
                const mode = this.currentReport.mode;

                if (mode === 'single') {
                    // å•ä»»åŠ¡æ¨¡å¼ï¼šéå†æ‰€æœ‰æ¨¡å‹çš„æ‰€æœ‰executions
                    this.currentReport.results.forEach((mr, modelIdx) => {
                        const model = mr.model;
                        const executions = mr.executions || [];

                        executions.forEach((exec, execIdx) => {
                            items.push({
                                id: exec.executionId || `exec_${modelIdx}_${execIdx}`,
                                type: 'execution',
                                modelId: model.id || `model_${modelIdx}`,
                                modelName: model.modelName,
                                executionIndex: exec.executionIndex !== undefined ? exec.executionIndex : execIdx,
                                content: exec.content,
                                success: exec.success,
                                error: exec.error,
                                responseTime: exec.responseTime,
                                tokensUsed: exec.tokensUsed
                            });
                        });
                    });
                } else if (mode === 'chain') {
                    // ä»»åŠ¡é“¾æ¨¡å¼ï¼šéå†æ‰€æœ‰æ¨¡å‹çš„æ‰€æœ‰steps
                    this.currentReport.results.forEach((mr, modelIdx) => {
                        const model = mr.model;
                        const steps = mr.steps || [];

                        steps.forEach((step, stepIdx) => {
                            items.push({
                                id: step.stepId || `step_${modelIdx}_${stepIdx}`,
                                type: 'step',
                                modelId: model.id || `model_${modelIdx}`,
                                modelName: model.modelName,
                                stepIndex: step.stepIndex !== undefined ? step.stepIndex : stepIdx,
                                taskName: step.task?.name || `ä»»åŠ¡${stepIdx + 1}`,
                                content: step.result?.content,
                                success: step.result?.success,
                                error: step.result?.error,
                                responseTime: step.result?.responseTime,
                                tokensUsed: step.result?.tokensUsed
                            });
                        });
                    });
                }

                return items;
            }

            // æŒ‰æ¨¡å‹åˆ†ç»„æ¸²æŸ“è¯„åˆ†é¡¹
            renderScoringItemsByModel(scoringItems, template, scores, evaluation) {
                // æŒ‰æ¨¡å‹åˆ†ç»„
                const groupedByModel = {};
                scoringItems.forEach(item => {
                    if (!groupedByModel[item.modelId]) {
                        groupedByModel[item.modelId] = {
                            modelName: item.modelName,
                            items: []
                        };
                    }
                    groupedByModel[item.modelId].items.push(item);
                });

                return Object.entries(groupedByModel).map(([modelId, group]) => {
                    const modelItems = group.items;
                    const scoredCount = modelItems.filter(item => {
                        const itemScores = scores[item.id] || {};
                        return template.dimensions.every(dim => itemScores[dim.id]);
                    }).length;

                    return `
                        <div class="p-5 bg-white rounded-xl border-2 border-gray-200 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <h4 class="text-lg font-bold text-gray-800">${group.modelName}</h4>
                                    <span class="text-xs px-3 py-1 rounded-full ${
                                        scoredCount === modelItems.length ? 'bg-green-100 text-green-700' :
                                        scoredCount > 0 ? 'bg-yellow-100 text-yellow-700' :
                                        'bg-gray-100 text-gray-600'
                                    }">
                                        ${scoredCount}/${modelItems.length} å·²è¯„åˆ†
                                    </span>
                                </div>
                                ${evaluation.aiEnabled ? `
                                    <button onclick="window.reportManager.scoreModelAllExecutionsStep3('${modelId}')"
                                        class="px-4 py-2 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-medium">
                                        ğŸ¤– AIè¯„åˆ†æ­¤æ¨¡å‹æ‰€æœ‰è¾“å‡º
                                    </button>
                                ` : ''}
                            </div>

                            <!-- æŠ˜å /å±•å¼€æ§åˆ¶ -->
                            <button onclick="window.reportManager.toggleModelExpand('${modelId}')"
                                class="w-full mb-3 px-4 py-2 text-sm text-left bg-gray-50 hover:bg-gray-100 rounded-lg flex items-center justify-between">
                                <span>å±•å¼€/æŠ˜å  ${modelItems.length} ä¸ªè¾“å‡º</span>
                                <span id="expand-icon-${modelId}">â–¼</span>
                            </button>

                            <div id="model-items-${modelId}" class="space-y-4" style="display: block;">
                                ${modelItems.map(item => this.renderScoringItemCard(item, template, scores, evaluation)).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // æ¸²æŸ“å•ä¸ªè¯„åˆ†é¡¹å¡ç‰‡
            renderScoringItemCard(item, template, scores, evaluation) {
                const itemScores = scores[item.id] || {};
                const scoredDims = template.dimensions.filter(dim => itemScores[dim.id]).length;
                const isComplete = scoredDims === template.dimensions.length;

                const displayLabel = item.type === 'execution'
                    ? `æ‰§è¡Œ #${item.executionIndex + 1}`
                    : `æ­¥éª¤ #${item.stepIndex + 1}: ${item.taskName}`;

                return `
                    <div class="p-4 bg-gray-50 rounded-lg border ${isComplete ? 'border-green-300' : 'border-gray-300'}">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="text-base font-medium text-gray-700">${displayLabel}</span>
                                ${isComplete ? '<span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded">âœ“ å·²è¯„åˆ†</span>' : ''}
                            </div>
                            ${evaluation.aiEnabled ? `
                                <button onclick="window.reportManager.scoreSingleItemStep3('${item.id}')"
                                    class="px-3 py-1 text-xs bg-purple-500 text-white rounded hover:bg-purple-600">
                                    ğŸ¤– AIè¯„åˆ†
                                </button>
                            ` : ''}
                        </div>

                        <!-- è¾“å‡ºå†…å®¹é¢„è§ˆ -->
                        <div class="mb-3 p-3 bg-white rounded border border-gray-200">
                            ${item.success ? `
                                <p class="text-xs text-gray-700 line-clamp-3">${this.escapeHtml(item.content || '')}</p>
                            ` : `
                                <p class="text-xs text-red-600">âŒ ${this.escapeHtml(item.error || 'æ‰§è¡Œå¤±è´¥')}</p>
                            `}
                        </div>

                        <!-- è¯„åˆ†è¾“å…¥ -->
                        <div class="grid grid-cols-2 gap-2">
                            ${template.dimensions.map(dim => {
                                const score = itemScores[dim.id] || '';
                                return `
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">
                                            ${dim.name} (${dim.scoreRange.min}-${dim.scoreRange.max})
                                        </label>
                                        <input type="number"
                                            class="score-input-step3 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            data-item-id="${item.id}"
                                            data-dimension-id="${dim.id}"
                                            min="${dim.scoreRange.min}"
                                            max="${dim.scoreRange.max}"
                                            step="${dim.scoreRange.step || 1}"
                                            value="${score}"
                                            placeholder="è¯·è¯„åˆ†">
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        ${this.aiScoringReasons[item.id] ? `
                            <div class="mt-3 p-2 bg-blue-50 rounded border border-blue-200">
                                <p class="text-xs font-semibold text-blue-900 mb-1">ğŸ’¡ AIè¯„åˆ†ç†ç”±ï¼š</p>
                                <p class="text-xs text-blue-800">${this.escapeHtml(this.aiScoringReasons[item.id])}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // åˆ‡æ¢æ¨¡å‹å±•å¼€/æŠ˜å 
            toggleModelExpand(modelId) {
                const container = document.getElementById(`model-items-${modelId}`);
                const icon = document.getElementById(`expand-icon-${modelId}`);
                if (container && icon) {
                    const isExpanded = container.style.display !== 'none';
                    container.style.display = isExpanded ? 'none' : 'block';
                    icon.textContent = isExpanded ? 'â–¶' : 'â–¼';
                }
            }

            renderStep4() {
                const evaluation = this.currentReport.evaluation || {};
                const templateId = evaluation.templateId;

                if (!templateId) {
                    return `<div class="text-center py-12">
                        <p class="text-gray-600">è¯·å…ˆå®Œæˆå‰é¢çš„æ­¥éª¤</p>
                    </div>`;
                }

                const template = Storage.getEvaluationTemplate(templateId);
                const weights = evaluation.weights || {};
                const defaultWeight = (1 / template.dimensions.length).toFixed(3);

                return `
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-800">æ­¥éª¤ 4ï¼šæƒé‡é…ç½®ä¸è®¡ç®—</h3>

                        <div class="p-6 bg-white rounded-xl border-2 border-gray-200">
                            <h4 class="font-semibold text-gray-800 mb-4">æŒ‡æ ‡æƒé‡é…ç½®</h4>
                            <div class="space-y-4">
                                ${template.dimensions.map(dim => {
                                    const weight = weights[dim.id] || defaultWeight;
                                    return `
                                        <div>
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="text-sm font-medium text-gray-700">${dim.name}</span>
                                                <input type="number"
                                                    id="weight-input-${dim.id}"
                                                    class="weight-input px-2 py-1 w-20 border border-gray-300 rounded text-sm text-right"
                                                    data-dimension-id="${dim.id}"
                                                    value="${weight}"
                                                    min="0"
                                                    max="1"
                                                    step="0.01">
                                            </div>
                                            <input type="range"
                                                id="weight-slider-${dim.id}"
                                                class="weight-slider-step4 w-full"
                                                data-dimension-id="${dim.id}"
                                                value="${weight}"
                                                min="0"
                                                max="1"
                                                step="0.01">
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <p class="text-xs text-gray-600 mt-4">
                                ğŸ’¡ è¾“å…¥æ•°å­—åç‚¹å‡»å…¶ä»–åœ°æ–¹ï¼Œæƒé‡ä¼šè‡ªåŠ¨å½’ä¸€åŒ–ä¸ºæ€»å’Œ1.0
                            </p>
                        </div>

                        <div class="flex justify-between gap-3">
                            <button onclick="window.reportManager.goToStep(3)" class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 font-medium">
                                â† ä¸Šä¸€æ­¥
                            </button>
                            <button id="calculateFinalBtn" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl hover:from-purple-700 hover:to-pink-700 font-medium shadow-lg">
                                ğŸ“Š è®¡ç®—ç»¼åˆå¾—åˆ†
                            </button>
                        </div>

                        <div id="finalResults" class="mt-6" style="display: none;">
                            <!-- ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                `;
            }

            attachStepEventListeners() {
                // Step 1 äº‹ä»¶
                const templateSelect = document.getElementById('templateSelect');
                if (templateSelect) {
                    templateSelect.addEventListener('change', (e) => {
                        const templateId = e.target.value;
                        if (!this.currentReport.evaluation) {
                            this.currentReport.evaluation = {};
                        }
                        this.currentReport.evaluation.templateId = templateId;

                        // ğŸ”§ ä¿®å¤ï¼šåŒæ—¶ä¿å­˜templateçš„dimensionså’Œname
                        if (templateId) {
                            const template = Storage.getEvaluationTemplate(templateId);
                            if (template) {
                                this.currentReport.evaluation.dimensions = template.dimensions;
                                this.currentReport.evaluation.templateName = template.name;
                                console.log('[Step1] å·²ä¿å­˜æ¨¡æ¿ä¿¡æ¯:', {
                                    templateId,
                                    templateName: template.name,
                                    dimensions: template.dimensions
                                });
                            }
                        }

                        // æ˜¾ç¤ºæ¨¡æ¿é¢„è§ˆ
                        const preview = document.getElementById('templatePreview');
                        const nextBtn = document.getElementById('step1NextBtn');
                        if (templateId && preview && nextBtn) {
                            const template = Storage.getEvaluationTemplate(templateId);
                            preview.style.display = 'block';
                            preview.innerHTML = `
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <p class="text-sm font-medium text-gray-800 mb-2">è¯„æµ‹ç»´åº¦ï¼š</p>
                                    <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
                                        ${template.dimensions.map(d =>
                                            `<li>${d.name} (${d.scoreRange.min}-${d.scoreRange.max}åˆ†)</li>`
                                        ).join('')}
                                    </ul>
                                </div>
                            `;
                            nextBtn.disabled = false;
                        }
                    });
                }

                const step1NextBtn = document.getElementById('step1NextBtn');
                if (step1NextBtn) {
                    step1NextBtn.addEventListener('click', () => this.goToStep(2));
                }

                // Step 2 äº‹ä»¶
                const enableAICheckbox = document.getElementById('enableAIScoring');
                if (enableAICheckbox) {
                    enableAICheckbox.addEventListener('change', (e) => {
                        const panel = document.getElementById('aiConfigPanel');
                        if (panel) {
                            panel.style.display = e.target.checked ? 'block' : 'none';
                        }
                        if (!this.currentReport.evaluation) {
                            this.currentReport.evaluation = {};
                        }
                        this.currentReport.evaluation.aiEnabled = e.target.checked;
                    });
                }

                const step2NextBtn = document.getElementById('step2NextBtn');
                if (step2NextBtn) {
                    step2NextBtn.addEventListener('click', () => {
                        // ä¿å­˜AIé…ç½®
                        if (!this.currentReport.evaluation) {
                            this.currentReport.evaluation = {};
                        }
                        const refAnswer = document.getElementById('referenceAnswerInput');
                        const judgeModel = document.getElementById('judgeModelSelect');
                        const aiPrompt = document.getElementById('aiPromptTemplate');

                        if (refAnswer) this.currentReport.evaluation.referenceAnswer = refAnswer.value;
                        if (judgeModel) this.currentReport.evaluation.judgeModelId = judgeModel.value;
                        if (aiPrompt) this.currentReport.evaluation.aiPromptTemplate = aiPrompt.value;

                        this.goToStep(3);
                    });
                }

                // Step 3 äº‹ä»¶
                const step3NextBtn = document.getElementById('step3NextBtn');
                if (step3NextBtn) {
                    step3NextBtn.addEventListener('click', () => {
                        console.log('[Step3] ç‚¹å‡»ä¸‹ä¸€æ­¥ï¼Œå¼€å§‹ä¿å­˜è¯„åˆ†...');
                        this.saveStep3Scores();
                        console.log('[Step3] è¯„åˆ†ä¿å­˜å®Œæˆï¼Œè·³è½¬åˆ°Step4');
                        this.goToStep(4);
                    });
                }

                // Step 4 äº‹ä»¶ - æƒé‡å½’ä¸€åŒ–
                document.querySelectorAll('.weight-input').forEach(input => {
                    input.addEventListener('blur', () => this.normalizeWeights());
                    input.addEventListener('input', (e) => {
                        const dimId = e.target.dataset.dimensionId;
                        const slider = document.getElementById(`weight-slider-${dimId}`);
                        if (slider) slider.value = e.target.value;
                    });
                });

                document.querySelectorAll('.weight-slider-step4').forEach(slider => {
                    slider.addEventListener('input', (e) => {
                        const dimId = e.target.dataset.dimensionId;
                        const input = document.getElementById(`weight-input-${dimId}`);
                        if (input) input.value = e.target.value;
                    });
                    slider.addEventListener('change', () => this.normalizeWeights());
                });

                const calculateFinalBtn = document.getElementById('calculateFinalBtn');
                if (calculateFinalBtn) {
                    calculateFinalBtn.addEventListener('click', () => this.calculateFinalScoresStep4());
                }
            }

            saveStep3Scores() {
                console.log('[ä¿å­˜è¯„åˆ†] å¼€å§‹æ”¶é›†è¯„åˆ†æ•°æ®...');

                const scores = {};
                const inputs = document.querySelectorAll('.score-input-step3');

                console.log('[ä¿å­˜è¯„åˆ†] æ‰¾åˆ°è¯„åˆ†è¾“å…¥æ¡†æ•°é‡:', inputs.length);

                inputs.forEach((input, idx) => {
                    const itemId = input.dataset.itemId;  // executionId or stepId
                    const dimensionId = input.dataset.dimensionId;
                    const score = parseFloat(input.value);

                    console.log(`[ä¿å­˜è¯„åˆ†] è¾“å…¥æ¡† #${idx}: itemId=${itemId}, dimId=${dimensionId}, value="${input.value}", parsed=${score}`);

                    if (itemId && dimensionId && !isNaN(score)) {
                        if (!scores[itemId]) scores[itemId] = {};
                        scores[itemId][dimensionId] = score;
                    } else {
                        console.warn(`[ä¿å­˜è¯„åˆ†] âš ï¸ è¾“å…¥æ¡† #${idx} æ•°æ®ä¸å®Œæ•´æˆ–åˆ†æ•°æ— æ•ˆ`);
                    }
                });

                console.log('[ä¿å­˜è¯„åˆ†] æ”¶é›†åˆ°çš„è¯„åˆ†æ•°æ®:', scores);

                if (Object.keys(scores).length === 0) {
                    console.error('[ä¿å­˜è¯„åˆ†] âŒ æ²¡æœ‰æ”¶é›†åˆ°ä»»ä½•è¯„åˆ†æ•°æ®ï¼');
                    showToast('è¯·å…ˆè¾“å…¥è¯„åˆ†', 'error');
                    return;
                }

                if (!this.currentReport.evaluation) {
                    this.currentReport.evaluation = {};
                }
                this.currentReport.evaluation.scores = scores;

                // ä¿å­˜åˆ°localStorage
                const history = Storage.getHistory();
                const reportIndex = history.findIndex(h => h.id === this.currentReport.id);
                if (reportIndex !== -1) {
                    history[reportIndex].evaluation = this.currentReport.evaluation;
                    localStorage.setItem('evallite_history', JSON.stringify(history));
                    console.log('[ä¿å­˜è¯„åˆ†] âœ… å·²ä¿å­˜åˆ°localStorage');
                } else {
                    console.error('[ä¿å­˜è¯„åˆ†] âŒ æœªæ‰¾åˆ°å¯¹åº”çš„å†å²è®°å½•');
                }

                showToast('è¯„åˆ†å·²ä¿å­˜', 'success');
            }

            normalizeWeights() {
                const inputs = document.querySelectorAll('.weight-input');
                let total = 0;
                const values = [];

                inputs.forEach(input => {
                    const val = parseFloat(input.value) || 0;
                    values.push({ input, value: val, dimId: input.dataset.dimensionId });
                    total += val;
                });

                if (total === 0) return;

                values.forEach(({ input, value, dimId }) => {
                    const normalized = (value / total).toFixed(3);
                    input.value = normalized;
                    const slider = document.getElementById(`weight-slider-${dimId}`);
                    if (slider) slider.value = normalized;
                });

                showToast('æƒé‡å·²è‡ªåŠ¨å½’ä¸€åŒ–', 'info');
            }

            // AIè¯„åˆ†å•ä¸ªé¡¹ç›®ï¼ˆexecutionæˆ–stepï¼‰
            async scoreSingleItemStep3(itemId) {
                const evaluation = this.currentReport.evaluation;
                if (!evaluation || !evaluation.aiEnabled) return;

                const template = Storage.getEvaluationTemplate(evaluation.templateId);
                const judgeModelId = evaluation.judgeModelId;
                const judgeModel = Storage.getModels().find(m => m.id === judgeModelId);

                if (!judgeModel) {
                    showToast('è¯·å…ˆé…ç½®è¯„å§”æ¨¡å‹', 'error');
                    return;
                }

                // æ‰¾åˆ°å¯¹åº”çš„item
                const scoringItems = this.collectScoringItems();
                const item = scoringItems.find(i => i.id === itemId);
                if (!item || !item.content) {
                    showToast('æœªæ‰¾åˆ°è¾“å‡ºå†…å®¹', 'error');
                    return;
                }

                showToast(`æ­£åœ¨ä¸º ${item.modelName} çš„è¾“å‡ºè¿›è¡ŒAIè¯„åˆ†...`, 'info');

                try {
                    const taskDescription = this.currentReport.mode === 'single'
                        ? this.currentReport.task.userPrompt
                        : item.taskName || 'ä»»åŠ¡é“¾æ­¥éª¤';

                    const prompt = (evaluation.aiPromptTemplate || this.getDefaultAIPrompt(template))
                        .replace(/{task_description}/g, taskDescription)
                        .replace(/{model_output}/g, item.content)
                        .replace(/{reference_answer}/g, evaluation.referenceAnswer || '');

                    const response = await callModelAPI(
                        judgeModel.provider,
                        judgeModel.modelId,
                        judgeModel.apiKey,
                        [{ role: 'user', content: prompt }]
                    );

                    const { scores, reasoning } = this.parseAIScoreResponse(response.content, template);

                    // ä¿å­˜è¯„åˆ†ç†ç”±
                    if (reasoning) {
                        this.aiScoringReasons[itemId] = reasoning;
                    }

                    // ä¿å­˜è¯„åˆ†åˆ°evaluation
                    if (!evaluation.scores) evaluation.scores = {};
                    if (!evaluation.scores[itemId]) evaluation.scores[itemId] = {};
                    Object.assign(evaluation.scores[itemId], scores);

                    // æ›´æ–°è¾“å…¥æ¡†
                    template.dimensions.forEach(dim => {
                        const input = document.querySelector(`.score-input-step3[data-item-id="${itemId}"][data-dimension-id="${dim.id}"]`);
                        if (input && scores[dim.id] !== undefined) {
                            input.value = scores[dim.id];
                        }
                    });

                    showToast('AIè¯„åˆ†å®Œæˆ', 'success');

                } catch (error) {
                    console.error('AIè¯„åˆ†å¤±è´¥:', error);
                    showToast(`AIè¯„åˆ†å¤±è´¥: ${error.message}`, 'error');
                }
            }

            // AIè¯„åˆ†æŸä¸ªæ¨¡å‹çš„æ‰€æœ‰è¾“å‡º
            async scoreModelAllExecutionsStep3(modelId) {
                const evaluation = this.currentReport.evaluation;
                if (!evaluation || !evaluation.aiEnabled) return;

                const template = Storage.getEvaluationTemplate(evaluation.templateId);
                const judgeModel = Storage.getModels().find(m => m.id === evaluation.judgeModelId);

                if (!judgeModel) {
                    showToast('è¯·å…ˆé…ç½®è¯„å§”æ¨¡å‹', 'error');
                    return;
                }

                // æ‰¾åˆ°è¯¥æ¨¡å‹çš„æ‰€æœ‰items
                const scoringItems = this.collectScoringItems();
                const modelItems = scoringItems.filter(item => item.modelId === modelId);

                if (modelItems.length === 0) {
                    showToast('æœªæ‰¾åˆ°è¯¥æ¨¡å‹çš„è¾“å‡º', 'error');
                    return;
                }

                showToast(`å¼€å§‹æ‰¹é‡AIè¯„åˆ† ${modelItems[0].modelName} çš„ ${modelItems.length} ä¸ªè¾“å‡º...`, 'info');

                let successCount = 0;

                for (const item of modelItems) {
                    if (!item.content) continue;

                    try {
                        const taskDescription = this.currentReport.mode === 'single'
                            ? this.currentReport.task.userPrompt
                            : item.taskName || 'ä»»åŠ¡é“¾æ­¥éª¤';

                        const prompt = (evaluation.aiPromptTemplate || this.getDefaultAIPrompt(template))
                            .replace(/{task_description}/g, taskDescription)
                            .replace(/{model_output}/g, item.content)
                            .replace(/{reference_answer}/g, evaluation.referenceAnswer || '');

                        const response = await callModelAPI(
                            judgeModel.provider,
                            judgeModel.modelId,
                            judgeModel.apiKey,
                            [{ role: 'user', content: prompt }]
                        );

                        const { scores, reasoning } = this.parseAIScoreResponse(response.content, template);

                        // ä¿å­˜è¯„åˆ†
                        if (!evaluation.scores) evaluation.scores = {};
                        if (!evaluation.scores[item.id]) evaluation.scores[item.id] = {};
                        Object.assign(evaluation.scores[item.id], scores);

                        if (reasoning) {
                            this.aiScoringReasons[item.id] = reasoning;
                        }

                        // æ›´æ–°è¾“å…¥æ¡†
                        template.dimensions.forEach(dim => {
                            const input = document.querySelector(`.score-input-step3[data-item-id="${item.id}"][data-dimension-id="${dim.id}"]`);
                            if (input && scores[dim.id] !== undefined) {
                                input.value = scores[dim.id];
                            }
                        });

                        successCount++;

                    } catch (error) {
                        console.error(`AIè¯„åˆ†å¤±è´¥ (${item.id}):`, error);
                    }
                }

                showToast(`AIè¯„åˆ†å®Œæˆï¼šæˆåŠŸ ${successCount}/${modelItems.length}`, 'success');
                this.saveStep3Scores(); // è‡ªåŠ¨ä¿å­˜
            }

            // æ‰¹é‡AIè¯„åˆ†æ‰€æœ‰æ¨¡å‹çš„æ‰€æœ‰è¾“å‡º
            async batchAIScoringStep3() {
                const evaluation = this.currentReport.evaluation;
                if (!evaluation || !evaluation.aiEnabled) return;

                const template = Storage.getEvaluationTemplate(evaluation.templateId);
                const judgeModel = Storage.getModels().find(m => m.id === evaluation.judgeModelId);

                if (!judgeModel) {
                    showToast('è¯·å…ˆé…ç½®è¯„å§”æ¨¡å‹', 'error');
                    return;
                }

                const scoringItems = this.collectScoringItems();
                showToast(`å¼€å§‹æ‰¹é‡AIè¯„åˆ† ${scoringItems.length} ä¸ªè¾“å‡º...`, 'info');

                let successCount = 0;

                for (const item of scoringItems) {
                    if (!item.content) continue;

                    try {
                        const taskDescription = this.currentReport.mode === 'single'
                            ? this.currentReport.task.userPrompt
                            : item.taskName || 'ä»»åŠ¡é“¾æ­¥éª¤';

                        const prompt = (evaluation.aiPromptTemplate || this.getDefaultAIPrompt(template))
                            .replace(/{task_description}/g, taskDescription)
                            .replace(/{model_output}/g, item.content)
                            .replace(/{reference_answer}/g, evaluation.referenceAnswer || '');

                        const response = await callModelAPI(
                            judgeModel.provider,
                            judgeModel.modelId,
                            judgeModel.apiKey,
                            [{ role: 'user', content: prompt }]
                        );

                        const { scores, reasoning } = this.parseAIScoreResponse(response.content, template);

                        // ä¿å­˜è¯„åˆ†
                        if (!evaluation.scores) evaluation.scores = {};
                        if (!evaluation.scores[item.id]) evaluation.scores[item.id] = {};
                        Object.assign(evaluation.scores[item.id], scores);

                        if (reasoning) {
                            this.aiScoringReasons[item.id] = reasoning;
                        }

                        // æ›´æ–°è¾“å…¥æ¡†
                        template.dimensions.forEach(dim => {
                            const input = document.querySelector(`.score-input-step3[data-item-id="${item.id}"][data-dimension-id="${dim.id}"]`);
                            if (input && scores[dim.id] !== undefined) {
                                input.value = scores[dim.id];
                            }
                        });

                        successCount++;

                    } catch (error) {
                        console.error(`AIè¯„åˆ†å¤±è´¥ (${item.id}):`, error);
                    }
                }

                showToast(`æ‰¹é‡AIè¯„åˆ†å®Œæˆï¼šæˆåŠŸ ${successCount}/${scoringItems.length}`, 'success');
                this.saveStep3Scores(); // è‡ªåŠ¨ä¿å­˜
            }

            // è§£æAIè¯„åˆ†å“åº”
            parseAIScoreResponse(content, template) {
                let scores = {};
                let reasoning = '';

                try {
                    const data = JSON.parse(content);
                    reasoning = data.reasoning || '';

                    template.dimensions.forEach((dim, idx) => {
                        let score = 0;

                        // å°è¯•å¤šç§åŒ¹é…ç­–ç•¥
                        if (data[dim.name] !== undefined) {
                            score = parseFloat(data[dim.name]);
                        } else if (data[dim.id] !== undefined) {
                            score = parseFloat(data[dim.id]);
                        } else if (data[idx] !== undefined) {
                            score = parseFloat(data[idx]);
                        } else if (data[`dimension_${idx + 1}`] !== undefined) {
                            score = parseFloat(data[`dimension_${idx + 1}`]);
                        }

                        scores[dim.id] = score || 0;
                    });
                } catch (parseError) {
                    // JSONè§£æå¤±è´¥ï¼Œå°è¯•æå–æ•°å­—
                    const numbers = content.match(/\d+(\.\d+)?/g) || [];
                    template.dimensions.forEach((dim, idx) => {
                        scores[dim.id] = idx < numbers.length ? parseFloat(numbers[idx]) : 0;
                    });
                }

                return { scores, reasoning };
            }

            calculateFinalScoresStep4() {
                const evaluation = this.currentReport.evaluation;
                if (!evaluation || !evaluation.scores) {
                    showToast('è¯·å…ˆå®Œæˆè¯„åˆ†', 'error');
                    return;
                }

                const template = Storage.getEvaluationTemplate(evaluation.templateId);

                // æ”¶é›†æƒé‡
                const weights = {};
                document.querySelectorAll('.weight-input').forEach(input => {
                    weights[input.dataset.dimensionId] = parseFloat(input.value) || 0;
                });

                evaluation.weights = weights;

                // è®¡ç®—ç»¼åˆå¾—åˆ†ï¼ˆå¤ç”¨åŸæœ‰é€»è¾‘ï¼‰
                this.calculateFinalScores();

                // è®¡ç®—å®Œæˆåï¼Œæ˜¾ç¤ºæˆåŠŸæç¤ºå¹¶è·³è½¬åˆ°å¯è§†åŒ–åˆ†æ
                setTimeout(() => {
                    showToast('æ­£åœ¨è·³è½¬åˆ°å¯è§†åŒ–åˆ†æ...', 'info');
                    this.switchTab('visualization');
                }, 1000);
            }

            attachScoringEventListeners() {
                // æ–°çš„æ­¥éª¤åŒ–æµç¨‹ä½¿ç”¨ attachStepEventListeners
                this.attachStepEventListeners();
            }

            loadTemplate(templateId) {
                if (!templateId) {
                    document.getElementById('dimensionsList').innerHTML = '<p class="text-gray-500 text-sm">è¯·å…ˆé€‰æ‹©è¯„æµ‹æ¨¡æ¿</p>';
                    document.getElementById('aiAutoScoreBtn').style.display = 'none';
                    return;
                }

                const template = Storage.getEvaluationTemplate(templateId);
                if (!template) return;

                // æ˜¾ç¤ºAIè‡ªåŠ¨è¯„åˆ†æŒ‰é’®(å¦‚æœæ¨¡æ¿æ”¯æŒ)
                const aiScoreBtn = document.getElementById('aiAutoScoreBtn');
                if (aiScoreBtn && template.aiScoringConfig?.enabled) {
                    aiScoreBtn.style.display = 'block';
                }

                const evaluation = this.currentReport.evaluation || { scores: {} };

                // æ¸²æŸ“è¯„åˆ†ç»´åº¦
                const dimensionsList = document.getElementById('dimensionsList');
                dimensionsList.innerHTML = `
                    <div class="space-y-4">
                        ${this.currentReport.results.map((modelResult, modelIdx) => {
                            const modelId = modelResult.model.id || `model_${modelIdx}`;
                            const modelScores = evaluation.scores?.[modelId];
                            const isScored = modelScores && Object.keys(modelScores).length > 0;

                            return `
                                <div class="p-4 bg-white border-2 ${isScored ? 'border-green-300' : 'border-gray-200'} rounded-xl">
                                    <div class="flex justify-between items-start mb-3">
                                        <h4 class="font-semibold text-gray-800">
                                            ${modelResult.model.modelName}
                                            ${isScored ? '<span class="ml-2 text-xs px-2 py-1 bg-green-100 text-green-700 rounded">âœ“ å·²è¯„åˆ†</span>' : ''}
                                        </h4>
                                        ${template.aiScoringConfig?.enabled ? `
                                            <button
                                                onclick="window.reportManager.scoreSingleModel('${modelId}', ${modelIdx})"
                                                class="text-xs px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                                ğŸ¤– AIè¯„åˆ†
                                            </button>
                                        ` : ''}
                                    </div>
                                    <div class="space-y-3">
                                        ${template.dimensions.map(dim => {
                                            const currentScore = evaluation.scores?.[modelId]?.[dim.id] || 0;
                                            return `
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                                        ${dim.name} (${dim.scoreRange.min}-${dim.scoreRange.max})
                                                    </label>
                                                    <input
                                                        type="number"
                                                        data-model-id="${modelId}"
                                                        data-dimension-id="${dim.id}"
                                                        min="${dim.scoreRange.min}"
                                                        max="${dim.scoreRange.max}"
                                                        step="${dim.scoreRange.step || 1}"
                                                        value="${currentScore}"
                                                        class="score-input w-full px-3 py-2 border border-gray-200 rounded-lg"
                                                    >
                                                    ${dim.description ? `<p class="text-xs text-gray-500 mt-1">${dim.description}</p>` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;

                // æ˜¾ç¤ºæƒé‡é…ç½®
                this.renderWeightsConfig(template.dimensions);
            }

            renderWeightsConfig(dimensions) {
                const weightsConfig = document.getElementById('weightsConfig');
                const weightsSliders = document.getElementById('weightsSliders');

                weightsConfig.style.display = 'block';

                const evaluation = this.currentReport.evaluation || {};
                const weights = evaluation.weights || {};

                // é»˜è®¤å‡åˆ†æƒé‡
                const defaultWeight = (100 / dimensions.length).toFixed(0);

                weightsSliders.innerHTML = dimensions.map(dim => {
                    const weight = weights[dim.id] || defaultWeight;
                    return `
                        <div class="mb-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-700">${dim.name}</span>
                                <span class="text-sm font-semibold text-purple-600"><span id="weight-${dim.id}-value">${weight}</span>%</span>
                            </div>
                            <input
                                type="range"
                                id="weight-${dim.id}"
                                data-dimension-id="${dim.id}"
                                class="weight-slider"
                                min="0"
                                max="100"
                                value="${weight}"
                            >
                        </div>
                    `;
                }).join('');

                // æ·»åŠ æƒé‡æ»‘å—äº‹ä»¶
                dimensions.forEach(dim => {
                    const slider = document.getElementById(`weight-${dim.id}`);
                    if (slider) {
                        slider.addEventListener('input', (e) => {
                            document.getElementById(`weight-${dim.id}-value`).textContent = e.target.value;
                        });
                    }
                });
            }

            async performAIScoring() {
                const templateId = document.getElementById('templateSelect')?.value;
                if (!templateId) {
                    showToast('è¯·å…ˆé€‰æ‹©è¯„æµ‹æ¨¡æ¿', 'error');
                    return;
                }

                const template = Storage.getEvaluationTemplate(templateId);
                if (!template || !template.aiScoringConfig?.enabled) {
                    showToast('è¯¥æ¨¡æ¿æœªé…ç½®AIè¯„åˆ†', 'error');
                    return;
                }

                // è·å–è¯„å§”æ¨¡å‹
                const judgeModelId = template.aiScoringConfig.judgeModelId;
                const allModels = Storage.getModels();
                const judgeModel = allModels.find(m => m.id === judgeModelId);

                if (!judgeModel) {
                    showToast('è¯„å§”æ¨¡å‹æœªæ‰¾åˆ°', 'error');
                    return;
                }

                // è·å–å‚è€ƒç­”æ¡ˆ
                const referenceAnswer = document.getElementById('referenceAnswerInput')?.value || '';

                showToast('å¼€å§‹AIè‡ªåŠ¨è¯„åˆ†...', 'info');

                const scores = {};

                // å¯¹æ¯ä¸ªè¢«æµ‹æ¨¡å‹è¿›è¡Œè¯„åˆ†
                for (const [idx, modelResult] of this.currentReport.results.entries()) {
                    const modelId = modelResult.model.id || `model_${idx}`;
                    const modelOutput = modelResult.executions[0].content;

                    // æ„å»ºè¯„åˆ†prompt
                    const promptTemplate = template.aiScoringConfig.promptTemplate || '';
                    const evaluationPrompt = promptTemplate
                        .replace(/{task_description}/g, this.currentReport.task.userPrompt)
                        .replace(/{model_output}/g, modelOutput)
                        .replace(/{reference_answer}/g, referenceAnswer);

                    try {
                        // è°ƒç”¨è¯„å§”æ¨¡å‹è¿›è¡Œè¯„åˆ†
                        const response = await callModelAPI(
                            judgeModel.provider,
                            judgeModel.modelId,
                            judgeModel.apiKey,
                            [{ role: 'user', content: evaluationPrompt }]
                        );

                        // å°è¯•è§£æJSONæ ¼å¼çš„è¯„åˆ†ç»“æœ
                        try {
                            const scoreData = JSON.parse(response.content);
                            scores[modelId] = {};

                            // å°†è¯„åˆ†æ˜ å°„åˆ°ç»´åº¦
                            template.dimensions.forEach((dim, dimIdx) => {
                                // å°è¯•ä»å¤šç§å¯èƒ½çš„å­—æ®µè·å–åˆ†æ•°
                                const score = scoreData[dim.name] ||
                                             scoreData[dim.id] ||
                                             scoreData[dimIdx] ||
                                             0;
                                scores[modelId][dim.id] = parseFloat(score) || 0;
                            });

                        } catch (parseError) {
                            // å¦‚æœæ— æ³•è§£æJSON,å°è¯•æå–æ•°å­—
                            const numbers = response.content.match(/\d+(\.\d+)?/g) || [];
                            scores[modelId] = {};

                            template.dimensions.forEach((dim, dimIdx) => {
                                scores[modelId][dim.id] = dimIdx < numbers.length
                                    ? parseFloat(numbers[dimIdx])
                                    : 0;
                            });
                        }

                    } catch (error) {
                        console.error(`AIè¯„åˆ†å¤±è´¥ (${modelResult.model.modelName}):`, error);
                        scores[modelId] = {};
                        template.dimensions.forEach(dim => {
                            scores[modelId][dim.id] = 0;
                        });
                    }
                }

                // æ›´æ–°UIä¸­çš„è¯„åˆ†è¾“å…¥æ¡†
                document.querySelectorAll('.score-input').forEach(input => {
                    const modelId = input.dataset.modelId;
                    const dimensionId = input.dataset.dimensionId;

                    if (scores[modelId] && scores[modelId][dimensionId] !== undefined) {
                        input.value = scores[modelId][dimensionId];
                    }
                });

                showToast('AIè‡ªåŠ¨è¯„åˆ†å®Œæˆ', 'success');
            }

            async scoreSingleModel(modelId, modelIdx) {
                const templateId = document.getElementById('templateSelect')?.value;
                if (!templateId) {
                    showToast('è¯·å…ˆé€‰æ‹©è¯„æµ‹æ¨¡æ¿', 'error');
                    return;
                }

                const template = Storage.getEvaluationTemplate(templateId);
                if (!template || !template.aiScoringConfig?.enabled) {
                    showToast('è¯¥æ¨¡æ¿æœªé…ç½®AIè¯„åˆ†', 'error');
                    return;
                }

                const judgeModelId = template.aiScoringConfig.judgeModelId;
                const allModels = Storage.getModels();
                const judgeModel = allModels.find(m => m.id === judgeModelId);

                if (!judgeModel) {
                    showToast('è¯„å§”æ¨¡å‹æœªæ‰¾åˆ°', 'error');
                    return;
                }

                const referenceAnswer = document.getElementById('referenceAnswerInput')?.value || '';
                const modelResult = this.currentReport.results[modelIdx];
                const modelOutput = modelResult.executions[0].content;

                showToast(`æ­£åœ¨ä¸º ${modelResult.model.modelName} è¿›è¡ŒAIè¯„åˆ†...`, 'info');

                const promptTemplate = template.aiScoringConfig.promptTemplate || '';
                const evaluationPrompt = promptTemplate
                    .replace(/{task_description}/g, this.currentReport.task.userPrompt)
                    .replace(/{model_output}/g, modelOutput)
                    .replace(/{reference_answer}/g, referenceAnswer);

                try {
                    const response = await callModelAPI(
                        judgeModel.provider,
                        judgeModel.modelId,
                        judgeModel.apiKey,
                        [{ role: 'user', content: evaluationPrompt }]
                    );

                    const scores = {};

                    try {
                        const scoreData = JSON.parse(response.content);
                        template.dimensions.forEach((dim, dimIdx) => {
                            const score = scoreData[dim.name] || scoreData[dim.id] || scoreData[dimIdx] || 0;
                            scores[dim.id] = parseFloat(score) || 0;
                        });
                    } catch (parseError) {
                        const numbers = response.content.match(/\d+(\.\d+)?/g) || [];
                        template.dimensions.forEach((dim, dimIdx) => {
                            scores[dim.id] = dimIdx < numbers.length ? parseFloat(numbers[dimIdx]) : 0;
                        });
                    }

                    // æ›´æ–°è¯¥æ¨¡å‹çš„è¯„åˆ†è¾“å…¥æ¡†
                    document.querySelectorAll(`.score-input[data-model-id="${modelId}"]`).forEach(input => {
                        const dimensionId = input.dataset.dimensionId;
                        if (scores[dimensionId] !== undefined) {
                            input.value = scores[dimensionId];
                        }
                    });

                    showToast(`${modelResult.model.modelName} AIè¯„åˆ†å®Œæˆ`, 'success');

                } catch (error) {
                    console.error('AIè¯„åˆ†å¤±è´¥:', error);
                    showToast(`AIè¯„åˆ†å¤±è´¥: ${error.message}`, 'error');
                }
            }

            saveScores() {
                const templateId = document.getElementById('templateSelect')?.value;
                if (!templateId) {
                    showToast('è¯·å…ˆé€‰æ‹©è¯„æµ‹æ¨¡æ¿', 'error');
                    return;
                }

                const template = Storage.getEvaluationTemplate(templateId);

                // æ”¶é›†è¯„åˆ†
                const scores = {};
                document.querySelectorAll('.score-input').forEach(input => {
                    const modelId = input.dataset.modelId;
                    const dimensionId = input.dataset.dimensionId;
                    const score = parseFloat(input.value) || 0;

                    if (!scores[modelId]) scores[modelId] = {};
                    scores[modelId][dimensionId] = score;
                });

                // æ”¶é›†æƒé‡
                const weights = {};
                template.dimensions.forEach(dim => {
                    const slider = document.getElementById(`weight-${dim.id}`);
                    if (slider) {
                        weights[dim.id] = parseFloat(slider.value) / 100; // è½¬æ¢ä¸º0-1
                    }
                });

                // è·å–å‚è€ƒç­”æ¡ˆ (v0.5)
                const referenceAnswer = document.getElementById('referenceAnswerInput')?.value || '';

                // è®¡ç®—å·²è¯„åˆ†æ¨¡å‹æ•° (v0.5)
                const scoredModels = Object.keys(scores).filter(modelId => {
                    return Object.keys(scores[modelId]).length > 0;
                }).length;
                const totalModels = this.currentReport.results.length;

                // ç¡®å®šè¯„æµ‹çŠ¶æ€ (v0.5)
                let status = 'draft';
                if (scoredModels === totalModels) {
                    status = 'in_progress'; // æ‰€æœ‰æ¨¡å‹éƒ½å·²è¯„åˆ†ï¼Œç­‰å¾…è®¡ç®—ç»¼åˆå¾—åˆ†
                } else if (scoredModels > 0) {
                    status = 'draft'; // éƒ¨åˆ†è¯„åˆ†
                }

                // ä¿å­˜åˆ°å†å²è®°å½•
                const evaluationData = {
                    status,  // v0.5
                    progress: {  // v0.5
                        scoredModels,
                        totalModels,
                        scoredDimensions: template.dimensions.map(d => d.id),
                        totalDimensions: template.dimensions.length,
                        lastUpdated: new Date().toISOString()
                    },
                    referenceAnswer,  // v0.5
                    templateId,
                    templateName: template.name,
                    dimensions: template.dimensions,
                    scores,
                    weights,
                    scoringHistory: this.currentReport.evaluation?.scoringHistory || []  // v0.5 ä¿ç•™å†å²
                };

                Storage.updateHistoryEvaluation(this.currentReport.id, evaluationData);

                // æ›´æ–°å½“å‰æŠ¥å‘Š
                this.currentReport.evaluation = evaluationData;

                showToast('è¯„åˆ†å·²ä¿å­˜(è‰ç¨¿)', 'success');
                this.renderHistoryList();
            }

            calculateFinalScores() {
                console.log('[è®¡ç®—ç»¼åˆå¾—åˆ†] å¼€å§‹è®¡ç®—...');

                const evaluation = this.currentReport.evaluation;

                console.log('[è®¡ç®—ç»¼åˆå¾—åˆ†] evaluationå­˜åœ¨?', !!evaluation);
                console.log('[è®¡ç®—ç»¼åˆå¾—åˆ†] scoreså­˜åœ¨?', !!evaluation?.scores);
                console.log('[è®¡ç®—ç»¼åˆå¾—åˆ†] weightså­˜åœ¨?', !!evaluation?.weights);
                console.log('[è®¡ç®—ç»¼åˆå¾—åˆ†] evaluationæ•°æ®:', evaluation);

                if (!evaluation || !evaluation.scores || !evaluation.weights) {
                    console.error('[è®¡ç®—ç»¼åˆå¾—åˆ†] âŒ ç¼ºå°‘å¿…è¦æ•°æ®');
                    showToast('è¯·å…ˆä¿å­˜è¯„åˆ†', 'error');
                    return;
                }

                // ä½¿ç”¨èšåˆå‡½æ•°è®¡ç®—æ¨¡å‹çº§åˆ«çš„ç»Ÿè®¡æ•°æ®
                console.log('[è®¡ç®—ç»¼åˆå¾—åˆ†] å¼€å§‹è®¡ç®—èšåˆæ•°æ®...');
                const aggregatedByModel = Storage.calculateAggregatedByModel(evaluation, this.currentReport);
                console.log('[è®¡ç®—ç»¼åˆå¾—åˆ†] èšåˆæ•°æ®:', aggregatedByModel);

                const finalResults = {};

                // è®¡ç®—æ¯ä¸ªæ¨¡å‹çš„ç»¼åˆå¾—åˆ†ï¼ˆåŸºäºå¹³å‡åˆ†ï¼‰
                Object.entries(aggregatedByModel).forEach(([modelId, modelData]) => {
                    const avgScores = modelData.avgScores;

                    let weightedSum = 0;
                    let totalWeight = 0;

                    evaluation.dimensions.forEach(dim => {
                        const score = avgScores[dim.id] || 0;
                        const weight = evaluation.weights[dim.id] || 0;
                        const normalized = score / dim.scoreRange.max;

                        weightedSum += normalized * weight;
                        totalWeight += weight;
                    });

                    const finalScore = totalWeight > 0 ? (weightedSum / totalWeight) * 100 : 0;

                    // è®¡ç®—å¹³å‡æˆæœ¬
                    const avgCost = modelData.avgCost || 0;

                    finalResults[modelId] = {
                        modelName: modelData.modelName,
                        rawScore: weightedSum / totalWeight,
                        finalScore: parseFloat(finalScore.toFixed(2)),
                        cost: avgCost,
                        costPerformanceRatio: avgCost > 0 ? finalScore / avgCost : 0,
                        // ä¿å­˜ç»Ÿè®¡ä¿¡æ¯ç”¨äºå¯è§†åŒ–
                        stats: {
                            avgScores: modelData.avgScores,
                            minScores: modelData.minScores,
                            maxScores: modelData.maxScores,
                            stdDevScores: modelData.stdDevScores,
                            executionCount: modelData.executionCount
                        }
                    };
                });

                // è®¡ç®—æ’å
                const sortedResults = Object.entries(finalResults).sort((a, b) => b[1].finalScore - a[1].finalScore);
                sortedResults.forEach(([modelId, result], index) => {
                    result.rank = index + 1;
                });

                // ä¿å­˜ç»¼åˆç»“æœå¹¶æ›´æ–°çŠ¶æ€ä¸º"å·²è¯„æµ‹"
                Storage.updateHistoryEvaluation(this.currentReport.id, {
                    ...evaluation,
                    status: 'evaluated',
                    finalResults,
                    aggregatedData: aggregatedByModel  // ä¿å­˜èšåˆæ•°æ®ä¾›å¯è§†åŒ–ä½¿ç”¨
                });

                this.currentReport.evaluation.finalResults = finalResults;
                this.currentReport.evaluation.aggregatedData = aggregatedByModel;
                this.currentReport.evaluation.status = 'evaluated';

                showToast('ç»¼åˆå¾—åˆ†è®¡ç®—å®Œæˆ', 'success');

                // æ˜¾ç¤ºç»“æœ
                this.showFinalResults(finalResults);

                // åˆ·æ–°å†å²åˆ—è¡¨
                this.renderHistoryList();
            }

            showFinalResults(finalResults) {
                const resultsHtml = `
                    <div class="p-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border-2 border-purple-200">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“Š ç»¼åˆè¯„æµ‹ç»“æœ</h3>
                        <div class="space-y-3">
                            ${Object.entries(finalResults).sort((a, b) => a[1].rank - b[1].rank).map(([modelId, result]) => `
                                <div class="flex items-center justify-between p-3 bg-white rounded-lg">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl font-bold ${result.rank === 1 ? 'text-yellow-500' : result.rank === 2 ? 'text-gray-400' : result.rank === 3 ? 'text-orange-500' : 'text-gray-400'}">
                                            ${result.rank === 1 ? 'ğŸ¥‡' : result.rank === 2 ? 'ğŸ¥ˆ' : result.rank === 3 ? 'ğŸ¥‰' : `#${result.rank}`}
                                        </span>
                                        <div>
                                            <p class="font-semibold text-gray-800">${result.modelName}</p>
                                            <p class="text-xs text-gray-500">æ€§ä»·æ¯”: ${result.costPerformanceRatio.toFixed(2)}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-2xl font-bold text-purple-600">${result.finalScore}</p>
                                        <p class="text-xs text-gray-500">æˆæœ¬: $${result.cost.toFixed(6)}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                const finalResultsDiv = document.getElementById('finalResults');
                if (finalResultsDiv) {
                    finalResultsDiv.innerHTML = resultsHtml;
                    finalResultsDiv.style.display = 'block';
                }
            }

            renderVisualizationTab() {
                const evaluation = this.currentReport.evaluation;

                if (!evaluation || !evaluation.finalResults) {
                    return `
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">ğŸ“Š</div>
                            <p class="text-gray-600 mb-4">è¿˜æ²¡æœ‰è¯„åˆ†æ•°æ®</p>
                            <button onclick="window.reportManager.switchTab('scoring')" class="btn-primary px-6 py-3 rounded-xl">
                                å»è¯„åˆ†
                            </button>
                        </div>
                    `;
                }

                // è®¡ç®—èšåˆæ•°æ®
                let aggregatedData = evaluation.aggregatedData;
                if (!aggregatedData) {
                    console.log('[å¯è§†åŒ–] è®¡ç®—èšåˆæ•°æ®...', {
                        evaluation,
                        historyRecord: this.currentReport
                    });
                    aggregatedData = Storage.calculateAggregatedByModel(evaluation, this.currentReport);
                    console.log('[å¯è§†åŒ–] èšåˆæ•°æ®è®¡ç®—å®Œæˆ:', aggregatedData);
                }

                // ç”Ÿæˆç»¼åˆæ’åæ¦œå•HTML
                const rankingHtml = this.generateRankingTable(evaluation.finalResults, aggregatedData);

                return `
                    <div class="space-y-6">
                        <!-- ç»¼åˆæ’åæ¦œå• -->
                        <div class="p-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border-2 border-purple-200">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“Š ç»¼åˆè¯„æµ‹æ’å</h3>
                            ${rankingHtml}
                        </div>

                        <!-- é›·è¾¾å›¾ -->
                        <div class="p-6 bg-white rounded-xl border-2 border-gray-200 shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">ğŸ¯ å¤šç»´åº¦èƒ½åŠ›å¯¹æ¯”é›·è¾¾å›¾</h3>
                            <p class="text-sm text-gray-600 mb-4">é¼ æ ‡æ‚¬åœæŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¹³å‡å€¼ã€èŒƒå›´ã€æ ‡å‡†å·®ï¼‰</p>
                            <div id="radarChart" style="width: 100%; height: 500px;"></div>
                        </div>

                        <!-- æˆæœ¬-æ€§èƒ½æ•£ç‚¹å›¾ -->
                        <div class="p-6 bg-white rounded-xl border-2 border-gray-200 shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">ğŸ’° æˆæœ¬-æ€§èƒ½åˆ†æ</h3>
                            <p class="text-sm text-gray-600 mb-4">æ¨ªè½´ï¼šå¹³å‡æˆæœ¬ | çºµè½´ï¼šç»¼åˆå¾—åˆ† | æ°”æ³¡å¤§å°ï¼šå¹³å‡å“åº”æ—¶é—´</p>
                            <div id="costChart" style="width: 100%; height: 450px;"></div>
                        </div>

                        <!-- è¯¦ç»†ç»Ÿè®¡è¡¨æ ¼ -->
                        <div class="p-6 bg-white rounded-xl border-2 border-gray-200 shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“ˆ å„ç»´åº¦è¯¦ç»†ç»Ÿè®¡</h3>
                            ${this.generateDetailedStatsTable(evaluation, aggregatedData)}
                        </div>
                    </div>
                `;
            }

            // ç”Ÿæˆæ’åæ¦œå•è¡¨æ ¼
            generateRankingTable(finalResults, aggregatedData) {
                const sortedResults = Object.entries(finalResults).sort((a, b) => a[1].rank - b[1].rank);

                return `
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b-2 border-purple-300">
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">æ’å</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">æ¨¡å‹</th>
                                    <th class="py-3 px-4 text-center text-sm font-semibold text-gray-700">ç»¼åˆå¾—åˆ†</th>
                                    <th class="py-3 px-4 text-center text-sm font-semibold text-gray-700">æ ·æœ¬æ•°</th>
                                    <th class="py-3 px-4 text-center text-sm font-semibold text-gray-700">å¹³å‡æˆæœ¬</th>
                                    <th class="py-3 px-4 text-center text-sm font-semibold text-gray-700">æ€§ä»·æ¯”</th>
                                    <th class="py-3 px-4 text-center text-sm font-semibold text-gray-700">å¹³å‡è€—æ—¶</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedResults.map(([modelId, result]) => {
                                    const modelData = aggregatedData[modelId];
                                    const rankEmoji = result.rank === 1 ? 'ğŸ¥‡' : result.rank === 2 ? 'ğŸ¥ˆ' : result.rank === 3 ? 'ğŸ¥‰' : `#${result.rank}`;
                                    const rowClass = result.rank === 1 ? 'bg-yellow-50' : result.rank === 2 ? 'bg-gray-50' : result.rank === 3 ? 'bg-orange-50' : '';

                                    return `
                                        <tr class="${rowClass} border-b border-gray-200 hover:bg-purple-50 transition">
                                            <td class="py-3 px-4">
                                                <span class="text-2xl">${rankEmoji}</span>
                                            </td>
                                            <td class="py-3 px-4">
                                                <div class="font-semibold text-gray-800">${result.modelName}</div>
                                            </td>
                                            <td class="py-3 px-4 text-center">
                                                <div class="text-2xl font-bold text-purple-600">${result.finalScore}</div>
                                            </td>
                                            <td class="py-3 px-4 text-center">
                                                <span class="text-sm px-2 py-1 bg-blue-100 text-blue-700 rounded">${result.stats.executionCount}</span>
                                            </td>
                                            <td class="py-3 px-4 text-center">
                                                <div class="text-sm text-gray-700">$${result.cost.toFixed(6)}</div>
                                            </td>
                                            <td class="py-3 px-4 text-center">
                                                <div class="text-sm font-medium text-green-600">${result.costPerformanceRatio.toFixed(0)}</div>
                                            </td>
                                            <td class="py-3 px-4 text-center">
                                                <div class="text-sm text-gray-700">${modelData.avgResponseTime?.toFixed(0) || 0}ms</div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // ç”Ÿæˆè¯¦ç»†ç»Ÿè®¡è¡¨æ ¼
            generateDetailedStatsTable(evaluation, aggregatedData) {
                return `
                    <div class="space-y-4">
                        ${Object.entries(aggregatedData).map(([modelId, modelData]) => `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-3">${modelData.modelName}</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    ${evaluation.dimensions.map(dim => `
                                        <div class="bg-gray-50 rounded p-3">
                                            <div class="text-sm font-medium text-gray-700 mb-2">${dim.name}</div>
                                            <div class="space-y-1 text-xs text-gray-600">
                                                <div>å¹³å‡: <span class="font-semibold text-purple-600">${modelData.avgScores[dim.id]?.toFixed(2) || 0}</span> / ${dim.scoreRange.max}</div>
                                                <div>èŒƒå›´: ${modelData.minScores[dim.id]?.toFixed(2) || 0} - ${modelData.maxScores[dim.id]?.toFixed(2) || 0}</div>
                                                <div>æ ‡å‡†å·®: ${modelData.stdDevScores[dim.id]?.toFixed(2) || 0}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            renderCharts() {
                this.renderRadarChart();
                this.renderCostChart();
            }

            renderRadarChart() {
                const evaluation = this.currentReport.evaluation;
                if (!evaluation) {
                    console.warn('[é›·è¾¾å›¾] evaluationæ•°æ®ä¸ºç©º');
                    return;
                }

                const chartDom = document.getElementById('radarChart');
                if (!chartDom) {
                    console.warn('[é›·è¾¾å›¾] æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨ #radarChart');
                    return;
                }

                if (this.radarChart) {
                    this.radarChart.dispose();
                }

                this.radarChart = echarts.init(chartDom);

                // å‡†å¤‡é›·è¾¾å›¾æ•°æ®
                const indicators = evaluation.dimensions.map(dim => ({
                    name: dim.name,
                    max: dim.scoreRange.max
                }));

                // ä½¿ç”¨èšåˆæ•°æ®
                const aggregatedData = evaluation.aggregatedData || Storage.calculateAggregatedByModel(evaluation, this.currentReport);

                console.log('[é›·è¾¾å›¾] èšåˆæ•°æ®:', aggregatedData);
                console.log('[é›·è¾¾å›¾] ç»´åº¦:', evaluation.dimensions);

                if (!aggregatedData || Object.keys(aggregatedData).length === 0) {
                    console.error('[é›·è¾¾å›¾] èšåˆæ•°æ®ä¸ºç©º');
                    return;
                }

                const seriesData = Object.entries(aggregatedData).map(([modelId, modelData]) => {
                    const avgValues = evaluation.dimensions.map(dim => modelData.avgScores[dim.id] || 0);

                    console.log(`[é›·è¾¾å›¾] ${modelData.modelName} å¹³å‡åˆ†:`, avgValues);

                    return {
                        name: modelData.modelName,
                        value: avgValues,
                        // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯åˆ°tooltip
                        executionCount: modelData.executionCount,
                        minScores: evaluation.dimensions.map(dim => modelData.minScores[dim.id] || 0),
                        maxScores: evaluation.dimensions.map(dim => modelData.maxScores[dim.id] || 0),
                        stdDevScores: evaluation.dimensions.map(dim => modelData.stdDevScores[dim.id] || 0)
                    };
                });

                const option = {
                    tooltip: {
                        trigger: 'item',
                        formatter: (params) => {
                            const data = params.data;
                            let html = `<strong>${data.name}</strong><br/>`;
                            html += `æ ·æœ¬æ•°: ${data.executionCount}<br/><br/>`;

                            evaluation.dimensions.forEach((dim, idx) => {
                                html += `<strong>${dim.name}</strong><br/>`;
                                html += `å¹³å‡: ${data.value[idx].toFixed(2)}<br/>`;
                                html += `èŒƒå›´: ${data.minScores[idx].toFixed(2)} - ${data.maxScores[idx].toFixed(2)}<br/>`;
                                html += `æ ‡å‡†å·®: ${data.stdDevScores[idx].toFixed(2)}<br/><br/>`;
                            });

                            return html;
                        }
                    },
                    legend: {
                        data: seriesData.map(s => s.name),
                        bottom: 10
                    },
                    radar: {
                        indicator: indicators,
                        radius: '60%'
                    },
                    series: [{
                        type: 'radar',
                        data: seriesData,
                        emphasis: {
                            lineStyle: {
                                width: 4
                            }
                        }
                    }]
                };

                this.radarChart.setOption(option);
            }

            renderCostChart() {
                const evaluation = this.currentReport.evaluation;
                if (!evaluation || !evaluation.finalResults) {
                    console.warn('[æˆæœ¬å›¾] evaluationæˆ–finalResultsä¸ºç©º');
                    return;
                }

                const chartDom = document.getElementById('costChart');
                if (!chartDom) {
                    console.warn('[æˆæœ¬å›¾] æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨ #costChart');
                    return;
                }

                if (this.costChart) {
                    this.costChart.dispose();
                }

                this.costChart = echarts.init(chartDom);

                const aggregatedData = evaluation.aggregatedData || Storage.calculateAggregatedByModel(evaluation, this.currentReport);

                console.log('[æˆæœ¬å›¾] èšåˆæ•°æ®:', aggregatedData);
                console.log('[æˆæœ¬å›¾] finalResults:', evaluation.finalResults);

                // å‡†å¤‡æ•£ç‚¹å›¾æ•°æ® - ä½¿ç”¨èšåˆæ•°æ®
                const data = Object.entries(evaluation.finalResults).map(([modelId, result]) => {
                    const modelData = aggregatedData[modelId];
                    const avgResponseTime = modelData.avgResponseTime || 1000;

                    return {
                        name: result.modelName,
                        value: [
                            result.cost * 1000000,  // è½¬æ¢ä¸ºç™¾ä¸‡åˆ†ä¹‹ä¸€ç¾å…ƒï¼Œä¾¿äºæ˜¾ç¤º
                            result.finalScore
                        ],
                        symbolSize: Math.max(10, Math.min(80, avgResponseTime / 50)),  // æ ¹æ®å“åº”æ—¶é—´è°ƒæ•´æ°”æ³¡å¤§å°
                        avgCost: result.cost,
                        avgResponseTime: avgResponseTime,
                        costPerformanceRatio: result.costPerformanceRatio,
                        executionCount: result.stats.executionCount
                    };
                });

                const option = {
                    tooltip: {
                        trigger: 'item',
                        formatter: (params) => {
                            const d = params.data;
                            return `<strong>${d.name}</strong><br/>` +
                                   `ç»¼åˆå¾—åˆ†: <strong>${d.value[1]}</strong><br/>` +
                                   `å¹³å‡æˆæœ¬: $${d.avgCost.toFixed(6)}<br/>` +
                                   `å¹³å‡è€—æ—¶: ${d.avgResponseTime.toFixed(0)}ms<br/>` +
                                   `æ€§ä»·æ¯”: ${d.costPerformanceRatio.toFixed(0)}<br/>` +
                                   `æ ·æœ¬æ•°: ${d.executionCount}`;
                        }
                    },
                    grid: {
                        left: '10%',
                        right: '10%',
                        bottom: '15%',
                        top: '10%'
                    },
                    xAxis: {
                        name: 'å¹³å‡æˆæœ¬ (ç™¾ä¸‡åˆ†ä¹‹ä¸€ç¾å…ƒ)',
                        nameLocation: 'center',
                        nameGap: 35,
                        nameTextStyle: {
                            fontSize: 12,
                            color: '#666'
                        },
                        axisLabel: {
                            formatter: (value) => value.toFixed(0)
                        }
                    },
                    yAxis: {
                        name: 'ç»¼åˆå¾—åˆ†',
                        nameLocation: 'center',
                        nameGap: 45,
                        nameTextStyle: {
                            fontSize: 12,
                            color: '#666'
                        },
                        min: 0,
                        max: 100
                    },
                    series: [{
                        type: 'scatter',
                        data: data,
                        label: {
                            show: true,
                            formatter: '{b}',
                            position: 'top',
                            fontSize: 11
                        },
                        itemStyle: {
                            color: (params) => {
                                // æ ¹æ®æ€§ä»·æ¯”ç€è‰²
                                const ratio = params.data.costPerformanceRatio;
                                if (ratio > 15000) return '#10b981'; // ç»¿è‰² - æ€§ä»·æ¯”é«˜
                                if (ratio > 10000) return '#3b82f6'; // è“è‰² - æ€§ä»·æ¯”ä¸­ç­‰
                                return '#f59e0b'; // æ©™è‰² - æ€§ä»·æ¯”ä½
                            },
                            opacity: 0.8
                        },
                        emphasis: {
                            itemStyle: {
                                opacity: 1,
                                shadowBlur: 10,
                                shadowColor: 'rgba(0, 0, 0, 0.3)'
                            }
                        }
                    }]
                };

                this.costChart.setOption(option);
            }

            renderExportTab() {
                return `
                    <div class="space-y-6">
                        <div class="p-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">å¯¼å‡ºé€‰é¡¹</h3>

                            <div class="space-y-3">
                                <button onclick="window.reportManager.exportPNG()" class="w-full px-6 py-3 bg-white border-2 border-blue-300 text-blue-600 rounded-xl hover:bg-blue-50 font-medium">
                                    ğŸ“¸ å¯¼å‡ºé›·è¾¾å›¾ä¸ºPNG
                                </button>

                                <button onclick="window.reportManager.exportHTML()" class="w-full px-6 py-3 bg-white border-2 border-purple-300 text-purple-600 rounded-xl hover:bg-purple-50 font-medium">
                                    ğŸ“„ å¯¼å‡ºå®Œæ•´HTMLæŠ¥å‘Š
                                </button>

                                <button onclick="window.reportManager.exportCSV()" class="w-full px-6 py-3 bg-white border-2 border-green-300 text-green-600 rounded-xl hover:bg-green-50 font-medium">
                                    ğŸ“Š å¯¼å‡ºCSVæ•°æ®
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            attachExportEventListeners() {
                // å¯¼å‡ºåŠŸèƒ½å·²é€šè¿‡onclickç»‘å®š
            }

            exportPNG() {
                if (!this.radarChart) {
                    showToast('è¯·å…ˆæŸ¥çœ‹å¯è§†åŒ–åˆ†æ', 'error');
                    return;
                }

                const url = this.radarChart.getDataURL({
                    type: 'png',
                    pixelRatio: 2,
                    backgroundColor: '#fff'
                });

                const link = document.createElement('a');
                link.href = url;
                link.download = `evaluation-radar-${Date.now()}.png`;
                link.click();

                showToast('é›·è¾¾å›¾å·²å¯¼å‡º', 'success');
            }

            exportHTML() {
                const evaluation = this.currentReport.evaluation;
                if (!evaluation || !evaluation.finalResults) {
                    showToast('è¯·å…ˆå®Œæˆè¯„åˆ†', 'error');
                    return;
                }

                const html = this.generateHTMLReport();
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `evaluation-report-${Date.now()}.html`;
                link.click();

                URL.revokeObjectURL(url);
                showToast('HTMLæŠ¥å‘Šå·²å¯¼å‡º', 'success');
            }

            generateHTMLReport() {
                const { task, mode, evaluation } = this.currentReport;
                const aggregatedData = evaluation.aggregatedData || Storage.calculateAggregatedByModel(evaluation, this.currentReport);

                const taskName = mode === 'single' ? task.name : 'ä»»åŠ¡é“¾è¯„æµ‹';

                return `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯„æµ‹æŠ¥å‘Š - ${this.escapeHtml(taskName)}</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        h1 { color: #7c3aed; }
        .model-result { border: 2px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .score-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .score-table th, .score-table td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
        .score-table th { background: #f3f4f6; }
        .rank-1 { background: #fef3c7; }
        .rank-2 { background: #f3f4f6; }
        .rank-3 { background: #fed7aa; }
        .stats { color: #6b7280; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>ğŸ“Š AIæ¨¡å‹è¯„æµ‹æŠ¥å‘Š</h1>
    <p><strong>ä»»åŠ¡:</strong> ${this.escapeHtml(taskName)}</p>
    <p><strong>æµ‹è¯•æ¨¡å¼:</strong> ${mode === 'single' ? 'å•ä»»åŠ¡' : 'ä»»åŠ¡é“¾'}</p>
    <p><strong>ç”Ÿæˆæ—¶é—´:</strong> ${new Date().toLocaleString('zh-CN')}</p>

    <h2>ç»¼åˆæ’å</h2>
    <table class="score-table">
        <thead>
            <tr>
                <th>æ’å</th>
                <th>æ¨¡å‹</th>
                <th>ç»¼åˆå¾—åˆ†</th>
                <th>å¹³å‡æˆæœ¬</th>
                <th>æ€§ä»·æ¯”</th>
                <th>æ ·æœ¬æ•°</th>
            </tr>
        </thead>
        <tbody>
            ${Object.entries(evaluation.finalResults || {}).sort((a, b) => a[1].rank - b[1].rank).map(([id, result]) => `
                <tr class="rank-${result.rank}">
                    <td>${result.rank}</td>
                    <td>${result.modelName}</td>
                    <td>${result.finalScore}</td>
                    <td>$${result.cost.toFixed(6)}</td>
                    <td>${result.costPerformanceRatio.toFixed(2)}</td>
                    <td>${result.stats.executionCount}</td>
                </tr>
            `).join('')}
        </tbody>
    </table>

    <h2>å„ç»´åº¦å¾—åˆ†ç»Ÿè®¡</h2>
    ${Object.entries(aggregatedData).map(([modelId, modelData]) => `
        <div class="model-result">
            <h3>${modelData.modelName}</h3>
            <p class="stats">åŸºäº ${modelData.executionCount} ä¸ªè¾“å‡ºçš„ç»Ÿè®¡ç»“æœ</p>
            ${evaluation.dimensions.map(dim => `
                <p>
                    <strong>${dim.name}:</strong><br/>
                    <span class="stats">
                        å¹³å‡: ${modelData.avgScores[dim.id]?.toFixed(2) || 0} / ${dim.scoreRange.max}<br/>
                        èŒƒå›´: ${modelData.minScores[dim.id]?.toFixed(2) || 0} - ${modelData.maxScores[dim.id]?.toFixed(2) || 0}<br/>
                        æ ‡å‡†å·®: ${modelData.stdDevScores[dim.id]?.toFixed(2) || 0}
                    </span>
                </p>
            `).join('')}
        </div>
    `).join('')}

    <hr style="margin: 30px 0; border: none; border-top: 2px solid #e5e7eb;">
    <p style="text-align: center; color: #6b7280; font-size: 0.9em;">
        ç”± EvalLite v0.6 ç”Ÿæˆ | ${new Date().toLocaleString('zh-CN')}
    </p>
</body>
</html>
                `;
            }

            exportCSV() {
                const { evaluation } = this.currentReport;
                if (!evaluation || !evaluation.finalResults) {
                    showToast('è¯·å…ˆå®Œæˆè¯„åˆ†', 'error');
                    return;
                }

                const aggregatedData = evaluation.aggregatedData || Storage.calculateAggregatedByModel(evaluation, this.currentReport);

                // ç”ŸæˆCSV - åŒ…å«å¹³å‡åˆ†ã€æœ€å°å€¼ã€æœ€å¤§å€¼ã€æ ‡å‡†å·®
                let csv = 'æ¨¡å‹,æ ·æœ¬æ•°,';

                // æ·»åŠ ç»´åº¦åˆ—ï¼ˆå¹³å‡åˆ†ã€æœ€å°å€¼ã€æœ€å¤§å€¼ã€æ ‡å‡†å·®ï¼‰
                evaluation.dimensions.forEach(d => {
                    csv += `${d.name}_å¹³å‡,${d.name}_æœ€å°,${d.name}_æœ€å¤§,${d.name}_æ ‡å‡†å·®,`;
                });
                csv += 'ç»¼åˆå¾—åˆ†,å¹³å‡æˆæœ¬,æ€§ä»·æ¯”,æ’å\n';

                Object.entries(aggregatedData).forEach(([modelId, modelData]) => {
                    const finalResult = evaluation.finalResults[modelId];

                    csv += `${modelData.modelName},${modelData.executionCount},`;

                    // æ·»åŠ æ¯ä¸ªç»´åº¦çš„ç»Ÿè®¡æ•°æ®
                    evaluation.dimensions.forEach(dim => {
                        csv += `${modelData.avgScores[dim.id]?.toFixed(2) || 0},`;
                        csv += `${modelData.minScores[dim.id]?.toFixed(2) || 0},`;
                        csv += `${modelData.maxScores[dim.id]?.toFixed(2) || 0},`;
                        csv += `${modelData.stdDevScores[dim.id]?.toFixed(2) || 0},`;
                    });

                    csv += `${finalResult.finalScore},${finalResult.cost.toFixed(6)},${finalResult.costPerformanceRatio.toFixed(2)},${finalResult.rank}\n`;
                });

                // æ·»åŠ BOMä»¥æ”¯æŒExcelæ­£ç¡®æ˜¾ç¤ºä¸­æ–‡
                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `evaluation-data-${Date.now()}.csv`;
                link.click();

                URL.revokeObjectURL(url);
                showToast('CSVæ•°æ®å·²å¯¼å‡º', 'success');
            }

            closeReportModal() {
                const modal = document.getElementById('reportModal');
                modal.classList.add('hidden');
                modal.style.display = 'none';
                this.currentReport = null;

                // é”€æ¯å›¾è¡¨
                if (this.radarChart) {
                    this.radarChart.dispose();
                    this.radarChart = null;
                }
                if (this.costChart) {
                    this.costChart.dispose();
                    this.costChart = null;
                }
            }

            deleteReport(index) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„æµ‹è®°å½•å—ï¼Ÿ')) return;

                const history = Storage.getHistory();
                history.splice(index, 1);
                localStorage.setItem('evallite_history', JSON.stringify(history));

                this.renderHistoryList();
                showToast('è®°å½•å·²åˆ é™¤', 'info');
            }

            clearAll() {
                if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è¯„æµ‹è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

                localStorage.removeItem('evallite_history');
                this.renderHistoryList();
                showToast('å·²æ¸…ç©ºæ‰€æœ‰è®°å½•', 'info');
            }

            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            formatDate(isoString) {
                const date = new Date(isoString);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }

        // åˆå§‹åŒ–
        window.reportManager = new ReportManager();
        window.showToast = showToast;
    </script>
</body>
</html>
