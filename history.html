<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史记录 - EvalLite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/common.css">
</head>
<body class="min-h-screen">
    <!-- 导航栏将通过JS插入 -->

    <!-- Main Content -->
    <main class="page-container">
        <!-- Header -->
        <div class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="page-title">历史记录</h1>
                <p class="page-subtitle">查看和管理您的测试历史</p>
            </div>
            <button id="clearAllBtn" class="px-4 py-2 text-red-600 border border-red-300 rounded-xl hover:bg-red-50 transition font-medium">
                清空历史
            </button>
        </div>

        <!-- History List -->
        <div id="historyList" class="space-y-4">
            <!-- History items will be rendered here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="glass-effect rounded-2xl p-12 text-center shadow-lg" style="display: none;">
            <div class="text-6xl mb-4">📊</div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">暂无历史记录</h3>
            <p class="text-gray-500 mb-6">执行测试后会自动保存在这里</p>
            <a href="test.html" class="btn-primary px-6 py-3 rounded-xl font-medium inline-block shadow-lg text-white">
                开始测试
            </a>
        </div>
    </main>

    <!-- Detail Modal -->
    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 overflow-y-auto" style="backdrop-filter: blur(5px);">
        <div class="glass-effect rounded-2xl max-w-4xl w-full mx-4 my-8 shadow-2xl">
            <div class="p-8">
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                        测试详情
                    </h2>
                    <div class="flex gap-2 items-center">
                        <button id="exportDetailCSVBtn" class="px-4 py-2 bg-green-50 text-green-600 border border-green-200 rounded-xl hover:bg-green-100 transition font-medium text-sm">
                            📥 导出CSV
                        </button>
                        <button id="closeDetailModal" class="text-gray-500 hover:text-gray-700 text-2xl">
                            ×
                        </button>
                    </div>
                </div>
                <div id="detailContent" class="max-h-[70vh] overflow-y-auto">
                    <!-- Detail will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { renderNavbar, showToast } from './js/navbar.js';
        import { Storage } from './js/storage.js';

        // 渲染导航栏
        renderNavbar('history');

        class HistoryManager {
            constructor() {
                this.currentDetailIndex = null;
                this.attachEventListeners();
                this.renderHistory();
            }

            attachEventListeners() {
                document.getElementById('clearAllBtn').addEventListener('click', () => this.clearAll());
                document.getElementById('closeDetailModal').addEventListener('click', () => this.closeDetailModal());
                document.getElementById('exportDetailCSVBtn').addEventListener('click', () => this.exportDetailCSV());

                // 点击模态框背景关闭
                document.getElementById('detailModal').addEventListener('click', (e) => {
                    if (e.target.id === 'detailModal') this.closeDetailModal();
                });
            }

            renderHistory() {
                const history = Storage.getHistory();
                const historyList = document.getElementById('historyList');
                const emptyState = document.getElementById('emptyState');

                if (history.length === 0) {
                    historyList.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }

                historyList.style.display = 'block';
                emptyState.style.display = 'none';

                historyList.innerHTML = history.map((item, index) => {
                    const modeText = item.mode === 'single' ? '单任务' : '任务链';
                    const taskName = item.mode === 'single' ? item.task.name : `任务链 (${item.chain.length}个任务)`;
                    const modelsCount = item.results.length;

                    // 评测状态和进度
                    const evaluation = item.evaluation || {};
                    const evalStatus = evaluation.status || 'not_started';
                    const progress = evaluation.progress || { scoredModels: 0, totalModels: modelsCount };

                    // 状态徽章配置
                    const statusConfig = {
                        'not_started': { emoji: '🔘', text: '未评测', color: 'bg-gray-500' },
                        'draft': { emoji: '📝', text: '评测中(草稿)', color: 'bg-blue-500' },
                        'in_progress': { emoji: '⚙️', text: '评测中', color: 'bg-blue-600' },
                        'evaluated': { emoji: '✅', text: '已评测', color: 'bg-green-500' },
                        'completed': { emoji: '📊', text: '已完成', color: 'bg-purple-500' }
                    };
                    const statusInfo = statusConfig[evalStatus];

                    // 评测按钮配置
                    let evaluationButton = '';
                    if (evalStatus === 'not_started') {
                        evaluationButton = `
                            <button
                                onclick="window.historyManager.startEvaluation(${index})"
                                class="px-4 py-2 text-white bg-gradient-to-r from-green-400 to-green-600 hover:from-green-500 hover:to-green-700 rounded-lg transition font-medium text-sm shadow-md">
                                开始评测
                            </button>
                        `;
                    } else if (evalStatus === 'draft' || evalStatus === 'in_progress') {
                        evaluationButton = `
                            <button
                                onclick="window.historyManager.continueEvaluation(${index})"
                                class="px-4 py-2 text-white bg-gradient-to-r from-blue-400 to-blue-600 hover:from-blue-500 hover:to-blue-700 rounded-lg transition font-medium text-sm shadow-md">
                                继续评测
                            </button>
                        `;
                    } else {
                        evaluationButton = `
                            <button
                                onclick="window.historyManager.viewEvaluation(${index})"
                                class="px-4 py-2 text-purple-600 hover:bg-purple-50 rounded-lg transition font-medium text-sm">
                                查看评测
                            </button>
                        `;
                    }

                    return `
                        <div class="glass-effect rounded-2xl p-6 shadow-lg card">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="px-3 py-1 text-xs font-medium text-white rounded-full bg-gradient-to-r ${item.mode === 'single' ? 'from-blue-400 to-blue-600' : 'from-purple-400 to-purple-600'}">
                                            ${modeText}
                                        </span>
                                        <span class="px-3 py-1 text-xs font-medium text-white rounded-full ${statusInfo.color}">
                                            ${statusInfo.emoji} ${statusInfo.text}
                                        </span>
                                        <h3 class="text-lg font-semibold text-gray-800">${this.escapeHtml(taskName)}</h3>
                                    </div>
                                    <p class="text-sm text-gray-500">${this.formatDate(item.timestamp)}</p>
                                    <p class="text-sm text-gray-600 mt-2">
                                        测试了 ${modelsCount} 个模型
                                        ${evalStatus !== 'not_started' ? ` | 已评分: ${progress.scoredModels}/${progress.totalModels}` : ''}
                                    </p>
                                    ${evalStatus !== 'not_started' && progress.lastUpdated ? `
                                        <p class="text-xs text-gray-500 mt-1">
                                            最后更新: ${this.formatRelativeTime(progress.lastUpdated)}
                                        </p>
                                    ` : ''}
                                </div>
                                <div class="flex gap-2 flex-wrap justify-end">
                                    ${evaluationButton}
                                    <button
                                        onclick="window.historyManager.viewDetail(${index})"
                                        class="px-4 py-2 text-blue-600 hover:bg-blue-50 rounded-lg transition font-medium text-sm">
                                        查看详情
                                    </button>
                                    <button
                                        onclick="window.historyManager.deleteItem(${index})"
                                        class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition font-medium text-sm">
                                        删除
                                    </button>
                                </div>
                            </div>

                            ${item.mode === 'single' && item.repeatCount > 1 ? `
                                <div class="pt-4 border-t border-gray-200">
                                    <p class="text-sm text-gray-600">
                                        <strong>重复次数:</strong> ${item.repeatCount}
                                    </p>
                                </div>
                            ` : ''}

                            ${(evalStatus === 'draft' || evalStatus === 'in_progress') && progress.scoredModels > 0 ? `
                                <div class="pt-4 border-t border-gray-200 mt-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <p class="text-sm font-medium text-gray-700">评测进度</p>
                                        <p class="text-sm text-gray-600">${Math.round((progress.scoredModels / progress.totalModels) * 100)}%</p>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-blue-400 to-blue-600 h-2 rounded-full transition-all duration-300"
                                             style="width: ${(progress.scoredModels / progress.totalModels) * 100}%"></div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }

            viewDetail(index) {
                const history = Storage.getHistory();
                const item = history[index];
                this.currentDetailIndex = index;

                const modal = document.getElementById('detailModal');
                const content = document.getElementById('detailContent');

                if (item.mode === 'single') {
                    content.innerHTML = this.renderSingleTaskDetail(item);
                } else {
                    content.innerHTML = this.renderChainDetail(item);
                }

                modal.style.display = 'flex';
            }

            renderSingleTaskDetail(item) {
                const { task, repeatCount, results } = item;

                return `
                    <div class="mb-6 p-4 bg-blue-50 rounded-xl border border-blue-200">
                        <h3 class="font-semibold text-blue-900 mb-2">任务信息</h3>
                        <p class="text-sm text-blue-800 mb-1"><strong>任务名称:</strong> ${this.escapeHtml(task.name)}</p>
                        ${task.systemPrompt ? `<p class="text-sm text-blue-800 mb-1"><strong>System Prompt:</strong> ${this.escapeHtml(task.systemPrompt)}</p>` : ''}
                        <p class="text-sm text-blue-800"><strong>User Prompt:</strong> ${this.escapeHtml(task.userPrompt)}</p>
                        ${repeatCount > 1 ? `<p class="text-sm text-blue-800 mt-2"><strong>重复次数:</strong> ${repeatCount}</p>` : ''}
                    </div>

                    ${results.map(modelResult => {
                        const { model, executions } = modelResult;
                        const successExecutions = executions.filter(e => e.success);
                        const avgResponseTime = successExecutions.length > 0
                            ? (successExecutions.reduce((sum, e) => sum + e.responseTime, 0) / successExecutions.length).toFixed(0)
                            : 0;

                        return `
                            <div class="bg-white border-2 border-gray-200 rounded-xl p-4 mb-4">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">${model.modelName}</h4>
                                        <p class="text-sm text-gray-600">${model.provider}</p>
                                    </div>
                                    ${repeatCount > 1 ? `
                                        <div class="text-right text-sm">
                                            <p class="text-gray-600">成功: ${successExecutions.length}/${repeatCount}</p>
                                            <p class="text-gray-500">平均耗时: ${avgResponseTime}ms</p>
                                        </div>
                                    ` : ''}
                                </div>

                                ${repeatCount === 1 && executions[0].success ? `
                                    <div class="bg-gray-50 p-3 rounded border border-gray-200 mb-2">
                                        <p class="text-gray-800 text-sm whitespace-pre-wrap">${this.escapeHtml(executions[0].content)}</p>
                                    </div>
                                    <p class="text-sm text-gray-600">耗时: ${executions[0].responseTime}ms | Tokens: ${executions[0].tokensUsed}</p>
                                ` : repeatCount > 1 ? `
                                    <div class="space-y-2 max-h-60 overflow-y-auto">
                                        ${executions.slice(0, 5).map((exec, i) => `
                                            <div class="border-l-4 ${exec.success ? 'border-green-500 bg-green-50' : 'border-red-500 bg-red-50'} p-2 rounded text-sm">
                                                <strong>执行 ${i + 1}:</strong> ${exec.success ? `${exec.responseTime}ms` : `失败 - ${exec.error}`}
                                            </div>
                                        `).join('')}
                                        ${executions.length > 5 ? `<p class="text-sm text-gray-500 text-center">... 共 ${executions.length} 次执行</p>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                `;
            }

            renderChainDetail(item) {
                const { results } = item;

                return results.map(modelResult => {
                    const { model, steps } = modelResult;

                    return `
                        <div class="mb-6 border-2 border-purple-300 rounded-xl p-4">
                            <h3 class="text-lg font-semibold mb-4 text-gray-800">
                                ${model.modelName} 任务链执行
                            </h3>

                            <div class="space-y-3">
                                ${steps.map((step, stepIndex) => {
                                    const { task, inputMode, result } = step;

                                    return `
                                        <div class="border-l-4 border-purple-400 pl-3">
                                            <div class="flex items-center mb-2">
                                                <span class="bg-purple-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">
                                                    ${stepIndex + 1}
                                                </span>
                                                <span class="font-medium text-sm">${this.escapeHtml(task.name)}</span>
                                                ${stepIndex > 0 ? `
                                                    <span class="ml-2 text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">
                                                        ${inputMode === 'previous' ? '使用上一输出' : inputMode === 'original' ? '使用原始prompt' : '拼接模式'}
                                                    </span>
                                                ` : ''}
                                            </div>

                                            ${result.success ? `
                                                <div class="bg-white border border-gray-200 rounded p-2 mb-1">
                                                    <p class="text-sm text-gray-800 line-clamp-3">${this.escapeHtml(result.content)}</p>
                                                </div>
                                                <p class="text-xs text-gray-500">${result.responseTime}ms | ${result.tokensUsed} tokens</p>
                                            ` : `
                                                <div class="bg-red-50 border border-red-200 rounded p-2">
                                                    <p class="text-sm text-red-600">❌ ${this.escapeHtml(result.error)}</p>
                                                </div>
                                            `}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            closeDetailModal() {
                document.getElementById('detailModal').style.display = 'none';
            }

            deleteItem(index) {
                if (!confirm('确定要删除这条历史记录吗？')) return;

                const history = Storage.getHistory();
                history.splice(index, 1);
                localStorage.setItem('evallite_history', JSON.stringify(history));

                this.renderHistory();
                showToast('历史记录已删除', 'info');
            }

            clearAll() {
                if (!confirm('确定要清空所有历史记录吗？此操作不可恢复！')) return;

                localStorage.removeItem('evallite_history');
                this.renderHistory();
                showToast('已清空所有历史记录', 'info');
            }

            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            formatDate(isoString) {
                const date = new Date(isoString);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            formatRelativeTime(isoString) {
                const date = new Date(isoString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);

                if (diffMins < 1) return '刚刚';
                if (diffMins < 60) return `${diffMins}分钟前`;
                if (diffHours < 24) return `${diffHours}小时前`;
                if (diffDays < 7) return `${diffDays}天前`;
                return this.formatDate(isoString);
            }

            startEvaluation(index) {
                const history = Storage.getHistory();
                const item = history[index];

                // 初始化评测数据
                if (!item.evaluation) {
                    item.evaluation = {
                        status: 'draft',
                        progress: {
                            scoredModels: 0,
                            totalModels: item.results.length,
                            scoredDimensions: [],
                            totalDimensions: 0,
                            lastUpdated: new Date().toISOString()
                        },
                        referenceAnswer: '',
                        scoringHistory: [],
                        templateId: null,
                        templateName: null,
                        dimensions: [],
                        scores: {},
                        weights: {},
                        综合Results: {},
                        chartConfig: {}
                    };

                    // 保存初始状态
                    localStorage.setItem('evallite_history', JSON.stringify(history));
                }

                // 跳转到评测报告页面，进入评分模式
                window.location.href = `reports.html?id=${item.id}&mode=evaluation&tab=scoring`;
            }

            continueEvaluation(index) {
                const history = Storage.getHistory();
                const item = history[index];

                // 跳转到评测报告页面，进入评分模式
                window.location.href = `reports.html?id=${item.id}&mode=evaluation&tab=scoring`;
            }

            viewEvaluation(index) {
                const history = Storage.getHistory();
                const item = history[index];

                // 跳转到评测报告页面，显示可视化标签
                window.location.href = `reports.html?id=${item.id}&tab=visualization`;
            }

            exportDetailCSV() {
                if (this.currentDetailIndex === null) {
                    showToast('请先查看详情', 'warning');
                    return;
                }

                const history = Storage.getHistory();
                const item = history[this.currentDetailIndex];

                if (!item) {
                    showToast('数据不存在', 'error');
                    return;
                }

                const { mode } = item;
                let csvContent;

                if (mode === 'single') {
                    csvContent = this.generateSingleTaskCSV(item);
                } else if (mode === 'chain') {
                    csvContent = this.generateChainTaskCSV(item);
                } else {
                    showToast('不支持的测试模式', 'error');
                    return;
                }

                // 创建Blob并下载
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' }); // 添加BOM支持中文
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `evallite-history-${Date.now()}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showToast('CSV已导出', 'success');
            }

            generateSingleTaskCSV(item) {
                const { task, repeatCount, results } = item;

                // CSV表头
                const headers = [
                    '模型名称',
                    '提供商',
                    '模型ID',
                    '任务名称',
                    '执行序号',
                    '状态',
                    '输出文本',
                    '耗时(ms)',
                    'Token数',
                    '错误信息',
                    '时间戳'
                ];

                const csvRows = [headers.join(',')];

                // 遍历每个模型的结果
                results.forEach(modelResult => {
                    const { model, executions } = modelResult;

                    executions.forEach((exec, index) => {
                        const row = [
                            `"${model.modelName}"`,
                            `"${model.provider}"`,
                            `"${model.modelId}"`,
                            `"${task.name}"`,
                            index + 1,
                            exec.success ? '成功' : '失败',
                            exec.success ? `"${(exec.content || '').replace(/"/g, '""')}"` : '', // 转义双引号
                            exec.success ? exec.responseTime : '',
                            exec.success ? (exec.tokensUsed || 0) : '',
                            exec.success ? '' : `"${(exec.error || '').replace(/"/g, '""')}"`,
                            exec.timestamp || ''
                        ];

                        csvRows.push(row.join(','));
                    });
                });

                return csvRows.join('\n');
            }

            generateChainTaskCSV(item) {
                const { results } = item;

                // CSV表头
                const headers = [
                    '模型名称',
                    '提供商',
                    '模型ID',
                    '步骤序号',
                    '任务名称',
                    '输入模式',
                    '状态',
                    '输出文本',
                    '耗时(ms)',
                    'Token数',
                    '错误信息',
                    '时间戳'
                ];

                const csvRows = [headers.join(',')];

                // 遍历每个模型的结果
                results.forEach(modelResult => {
                    const { model, steps } = modelResult;

                    steps.forEach((step, index) => {
                        const { task, inputMode, result } = step;
                        const inputModeText = inputMode === 'previous' ? '使用上一输出' :
                                             inputMode === 'original' ? '使用原始prompt' :
                                             inputMode === 'concat' ? '拼接模式' : inputMode;

                        const row = [
                            `"${model.modelName}"`,
                            `"${model.provider}"`,
                            `"${model.modelId}"`,
                            index + 1,
                            `"${task.name}"`,
                            `"${inputModeText}"`,
                            result.success ? '成功' : '失败',
                            result.success ? `"${(result.content || '').replace(/"/g, '""')}"` : '', // 转义双引号
                            result.success ? result.responseTime : '',
                            result.success ? (result.tokensUsed || 0) : '',
                            result.success ? '' : `"${(result.error || '').replace(/"/g, '""')}"`,
                            result.timestamp || ''
                        ];

                        csvRows.push(row.join(','));
                    });
                });

                return csvRows.join('\n');
            }
        }

        // 初始化
        window.historyManager = new HistoryManager();
        window.showToast = showToast;
    </script>
</body>
</html>
