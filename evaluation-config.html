<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯„æµ‹é…ç½® - EvalLite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/common.css">
</head>
<body class="min-h-screen">
    <!-- å¯¼èˆªæ å°†é€šè¿‡JSæ’å…¥ -->

    <!-- Main Content -->
    <main class="page-container">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="page-title">è¯„æµ‹é…ç½®</h1>
            <p class="page-subtitle">åˆ›å»ºå’Œç®¡ç†è¯„æµ‹ç»´åº¦æ¨¡æ¿</p>
        </div>

        <!-- Create Template Section -->
        <div class="glass-effect rounded-2xl p-6 mb-6 shadow-lg">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">åˆ›å»ºè¯„æµ‹æ¨¡æ¿</h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">æ¨¡æ¿åç§°</label>
                    <input type="text" id="templateName" placeholder="ä¾‹å¦‚ï¼šé€šç”¨è´¨é‡è¯„æµ‹" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 transition">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">æ¨¡æ¿æè¿°</label>
                    <textarea id="templateDescription" rows="2" placeholder="æè¿°è¿™ä¸ªè¯„æµ‹æ¨¡æ¿çš„ç”¨é€”..." class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 transition"></textarea>
                </div>

                <!-- Dimensions Section -->
                <div class="mt-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-md font-semibold text-gray-800">è¯„æµ‹ç»´åº¦</h3>
                        <button id="addDimensionBtn" class="px-4 py-2 text-purple-600 border border-purple-300 rounded-lg hover:bg-purple-50 transition font-medium text-sm">
                            + æ·»åŠ ç»´åº¦
                        </button>
                    </div>

                    <div id="dimensionsList" class="space-y-3">
                        <!-- Dimensions will be rendered here -->
                    </div>
                </div>

                <!-- AI Scoring Config -->
                <div class="mt-6 p-4 bg-blue-50 rounded-xl border border-blue-200">
                    <div class="flex items-center gap-2 mb-3">
                        <input type="checkbox" id="enableAiScoring" class="w-4 h-4 text-purple-600">
                        <label class="text-sm font-semibold text-gray-800">å¯ç”¨ AI è‡ªåŠ¨è¯„åˆ†</label>
                    </div>

                    <div id="aiScoringConfig" class="space-y-3" style="display: none;">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">è¯„å§”æ¨¡å‹</label>
                            <select id="judgeModelSelect" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 transition text-sm">
                                <option value="">é€‰æ‹©è¯„å§”æ¨¡å‹</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">è¯„åˆ† Prompt æ¨¡æ¿</label>
                            <textarea id="promptTemplate" rows="6" placeholder="è¯·ä½œä¸ºä¸€ä¸ªä¸“ä¸šè¯„å§”ï¼Œè¯„ä¼°ä»¥ä¸‹AIæ¨¡å‹çš„è¾“å‡ºè´¨é‡ã€‚&#10;&#10;ä»»åŠ¡ï¼š{task_description}&#10;å¾…è¯„ä¼°è¾“å‡ºï¼š{model_output}&#10;&#10;è¯·æŒ‰ä»¥ä¸‹ç»´åº¦æ‰“åˆ†ï¼ˆ0-5åˆ†ï¼‰ï¼š&#10;1. æµç•…åº¦&#10;2. å‡†ç¡®æ€§&#10;3. å®Œæ•´æ€§&#10;&#10;è¾“å‡ºæ ¼å¼ï¼šJSON" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 transition text-sm font-mono"></textarea>
                            <p class="text-xs text-gray-600 mt-1">ğŸ’¡ æ”¯æŒå˜é‡: {task_description}, {model_output}, {reference_answer}</p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex gap-3">
                    <button id="saveTemplateBtn" class="btn-primary px-6 py-3 rounded-xl font-medium shadow-lg">
                        ä¿å­˜æ¨¡æ¿
                    </button>
                    <button id="clearFormBtn" class="px-6 py-3 text-gray-700 border border-gray-300 rounded-xl hover:bg-gray-50 transition font-medium">
                        æ¸…ç©ºè¡¨å•
                    </button>
                </div>
            </div>
        </div>

        <!-- Templates List -->
        <div class="glass-effect rounded-2xl p-6 shadow-lg">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">å·²ä¿å­˜çš„æ¨¡æ¿</h2>
            <div id="templatesList" class="space-y-4">
                <!-- Templates will be rendered here -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="text-center py-12" style="display: none;">
                <div class="text-6xl mb-4">ğŸ“‹</div>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">è¿˜æ²¡æœ‰è¯„æµ‹æ¨¡æ¿</h3>
                <p class="text-gray-500 mb-6">åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªè¯„æµ‹æ¨¡æ¿</p>
            </div>
        </div>
    </main>

    <!-- Dimension Edit Modal -->
    <div id="dimensionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="backdrop-filter: blur(5px);">
        <div class="glass-effect rounded-2xl max-w-md w-full mx-4 p-6 shadow-2xl">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <span id="modalTitle">æ·»åŠ è¯„æµ‹ç»´åº¦</span>
            </h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç»´åº¦åç§°</label>
                    <input type="text" id="dimensionName" placeholder="ä¾‹å¦‚ï¼šæµç•…åº¦" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 transition">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è¯„åˆ†èŒƒå›´</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <input type="number" id="dimensionMin" placeholder="æœ€å°åˆ†" value="0" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 transition">
                        </div>
                        <div>
                            <input type="number" id="dimensionMax" placeholder="æœ€å¤§åˆ†" value="5" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 transition">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ­¥é•¿ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="number" id="dimensionStep" placeholder="ä¾‹å¦‚ï¼š0.5" step="0.1" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 transition">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è¯„åˆ†æ ‡å‡†è¯´æ˜</label>
                    <textarea id="dimensionDescription" rows="3" placeholder="æè¿°å¦‚ä½•ä¸ºè¿™ä¸ªç»´åº¦æ‰“åˆ†..." class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 transition"></textarea>
                </div>
            </div>

            <div class="mt-6 flex gap-3">
                <button id="saveDimensionBtn" class="flex-1 btn-primary px-4 py-2 rounded-lg font-medium">
                    ç¡®å®š
                </button>
                <button id="closeDimensionModal" class="flex-1 px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { renderNavbar, showToast } from './js/navbar.js';
        import { Storage } from './js/storage.js';

        // æ¸²æŸ“å¯¼èˆªæ 
        renderNavbar('evaluation-config');

        class EvaluationConfigManager {
            constructor() {
                this.currentDimensions = [];
                this.editingDimensionIndex = null;
                this.editingTemplateId = null;
                this.attachEventListeners();
                this.loadTemplates();
                this.loadModelsForJudge();
            }

            attachEventListeners() {
                document.getElementById('addDimensionBtn').addEventListener('click', () => this.openDimensionModal());
                document.getElementById('saveDimensionBtn').addEventListener('click', () => this.saveDimension());
                document.getElementById('closeDimensionModal').addEventListener('click', () => this.closeDimensionModal());
                document.getElementById('saveTemplateBtn').addEventListener('click', () => this.saveTemplate());
                document.getElementById('clearFormBtn').addEventListener('click', () => this.clearForm());
                document.getElementById('enableAiScoring').addEventListener('change', (e) => {
                    document.getElementById('aiScoringConfig').style.display = e.target.checked ? 'block' : 'none';
                });

                // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
                document.getElementById('dimensionModal').addEventListener('click', (e) => {
                    if (e.target.id === 'dimensionModal') this.closeDimensionModal();
                });
            }

            loadModelsForJudge() {
                const models = Storage.getModels();
                const select = document.getElementById('judgeModelSelect');

                select.innerHTML = '<option value="">é€‰æ‹©è¯„å§”æ¨¡å‹</option>' +
                    models.map(m => `<option value="${m.id}">${m.modelName} (${m.provider})</option>`).join('');
            }

            openDimensionModal(index = null) {
                this.editingDimensionIndex = index;
                const modal = document.getElementById('dimensionModal');
                const title = document.getElementById('modalTitle');

                if (index !== null) {
                    // ç¼–è¾‘æ¨¡å¼
                    title.textContent = 'ç¼–è¾‘è¯„æµ‹ç»´åº¦';
                    const dim = this.currentDimensions[index];
                    document.getElementById('dimensionName').value = dim.name;
                    document.getElementById('dimensionMin').value = dim.scoreRange.min;
                    document.getElementById('dimensionMax').value = dim.scoreRange.max;
                    document.getElementById('dimensionStep').value = dim.scoreRange.step || '';
                    document.getElementById('dimensionDescription').value = dim.description || '';
                } else {
                    // æ–°å¢æ¨¡å¼
                    title.textContent = 'æ·»åŠ è¯„æµ‹ç»´åº¦';
                    document.getElementById('dimensionName').value = '';
                    document.getElementById('dimensionMin').value = '0';
                    document.getElementById('dimensionMax').value = '5';
                    document.getElementById('dimensionStep').value = '';
                    document.getElementById('dimensionDescription').value = '';
                }

                modal.style.display = 'flex';
            }

            closeDimensionModal() {
                document.getElementById('dimensionModal').style.display = 'none';
                this.editingDimensionIndex = null;
            }

            saveDimension() {
                const name = document.getElementById('dimensionName').value.trim();
                const min = parseFloat(document.getElementById('dimensionMin').value);
                const max = parseFloat(document.getElementById('dimensionMax').value);
                const step = document.getElementById('dimensionStep').value;
                const description = document.getElementById('dimensionDescription').value.trim();

                if (!name) {
                    showToast('è¯·è¾“å…¥ç»´åº¦åç§°', 'error');
                    return;
                }

                if (isNaN(min) || isNaN(max) || min >= max) {
                    showToast('è¯„åˆ†èŒƒå›´æ— æ•ˆ', 'error');
                    return;
                }

                const dimension = {
                    id: this.editingDimensionIndex !== null
                        ? this.currentDimensions[this.editingDimensionIndex].id
                        : Storage.generateId(),
                    name,
                    type: 'custom',
                    scoreRange: {
                        min,
                        max,
                        ...(step && { step: parseFloat(step) })
                    },
                    description
                };

                if (this.editingDimensionIndex !== null) {
                    this.currentDimensions[this.editingDimensionIndex] = dimension;
                } else {
                    this.currentDimensions.push(dimension);
                }

                this.renderDimensions();
                this.closeDimensionModal();
                showToast('ç»´åº¦å·²ä¿å­˜', 'success');
            }

            renderDimensions() {
                const container = document.getElementById('dimensionsList');

                if (this.currentDimensions.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">æš‚æ— è¯„æµ‹ç»´åº¦ï¼Œç‚¹å‡»"æ·»åŠ ç»´åº¦"æŒ‰é’®åˆ›å»º</p>';
                    return;
                }

                container.innerHTML = this.currentDimensions.map((dim, index) => `
                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-200 flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">${this.escapeHtml(dim.name)}</div>
                            <div class="text-sm text-gray-600 mt-1">
                                èŒƒå›´: ${dim.scoreRange.min} - ${dim.scoreRange.max}
                                ${dim.scoreRange.step ? ` (æ­¥é•¿: ${dim.scoreRange.step})` : ''}
                            </div>
                            ${dim.description ? `<div class="text-xs text-gray-500 mt-1">${this.escapeHtml(dim.description)}</div>` : ''}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.evalConfigManager.openDimensionModal(${index})" class="text-blue-600 hover:text-blue-800 text-sm">
                                ç¼–è¾‘
                            </button>
                            <button onclick="window.evalConfigManager.removeDimension(${index})" class="text-red-600 hover:text-red-800 text-sm">
                                åˆ é™¤
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            removeDimension(index) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç»´åº¦å—ï¼Ÿ')) return;
                this.currentDimensions.splice(index, 1);
                this.renderDimensions();
                showToast('ç»´åº¦å·²åˆ é™¤', 'info');
            }

            saveTemplate() {
                const name = document.getElementById('templateName').value.trim();
                const description = document.getElementById('templateDescription').value.trim();

                if (!name) {
                    showToast('è¯·è¾“å…¥æ¨¡æ¿åç§°', 'error');
                    return;
                }

                if (this.currentDimensions.length === 0) {
                    showToast('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªè¯„æµ‹ç»´åº¦', 'error');
                    return;
                }

                const template = {
                    name,
                    description,
                    dimensions: this.currentDimensions
                };

                // AIè¯„åˆ†é…ç½®
                const enableAiScoring = document.getElementById('enableAiScoring').checked;
                if (enableAiScoring) {
                    const judgeModelId = document.getElementById('judgeModelSelect').value;
                    const promptTemplate = document.getElementById('promptTemplate').value.trim();

                    if (!judgeModelId) {
                        showToast('è¯·é€‰æ‹©è¯„å§”æ¨¡å‹', 'error');
                        return;
                    }

                    template.aiScoringConfig = {
                        enabled: true,
                        judgeModelId,
                        promptTemplate
                    };
                }

                if (this.editingTemplateId) {
                    // æ›´æ–°ç°æœ‰æ¨¡æ¿
                    Storage.updateEvaluationTemplate(this.editingTemplateId, template);
                    showToast('æ¨¡æ¿å·²æ›´æ–°', 'success');
                    this.editingTemplateId = null;
                } else {
                    // åˆ›å»ºæ–°æ¨¡æ¿
                    Storage.addEvaluationTemplate(template);
                    showToast('æ¨¡æ¿å·²ä¿å­˜', 'success');
                }

                this.clearForm();
                this.loadTemplates();
            }

            clearForm() {
                document.getElementById('templateName').value = '';
                document.getElementById('templateDescription').value = '';
                this.currentDimensions = [];
                this.renderDimensions();
                document.getElementById('enableAiScoring').checked = false;
                document.getElementById('aiScoringConfig').style.display = 'none';
                document.getElementById('judgeModelSelect').value = '';
                document.getElementById('promptTemplate').value = '';
                this.editingTemplateId = null;
            }

            loadTemplates() {
                const templates = Storage.getEvaluationTemplates();
                const container = document.getElementById('templatesList');
                const emptyState = document.getElementById('emptyState');

                if (templates.length === 0) {
                    container.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }

                container.style.display = 'block';
                emptyState.style.display = 'none';

                container.innerHTML = templates.map(template => `
                    <div class="p-4 bg-white border-2 border-gray-200 rounded-xl">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-800">${this.escapeHtml(template.name)}</h3>
                                ${template.description ? `<p class="text-sm text-gray-600 mt-1">${this.escapeHtml(template.description)}</p>` : ''}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="window.evalConfigManager.editTemplate('${template.id}')" class="px-3 py-1 text-blue-600 hover:bg-blue-50 rounded-lg transition text-sm">
                                    ç¼–è¾‘
                                </button>
                                <button onclick="window.evalConfigManager.deleteTemplate('${template.id}')" class="px-3 py-1 text-red-600 hover:bg-red-50 rounded-lg transition text-sm">
                                    åˆ é™¤
                                </button>
                            </div>
                        </div>

                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <p class="text-sm font-medium text-gray-700 mb-2">è¯„æµ‹ç»´åº¦ (${template.dimensions.length}):</p>
                            <div class="flex flex-wrap gap-2">
                                ${template.dimensions.map(dim => `
                                    <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs">
                                        ${this.escapeHtml(dim.name)} (${dim.scoreRange.min}-${dim.scoreRange.max})
                                    </span>
                                `).join('')}
                            </div>
                        </div>

                        ${template.aiScoringConfig?.enabled ? `
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <p class="text-sm text-green-600">âœ… å·²å¯ç”¨ AI è‡ªåŠ¨è¯„åˆ†</p>
                            </div>
                        ` : ''}

                        <div class="mt-3 text-xs text-gray-400">
                            åˆ›å»ºäº ${this.formatDate(template.createdAt)}
                        </div>
                    </div>
                `).join('');
            }

            editTemplate(templateId) {
                const template = Storage.getEvaluationTemplate(templateId);
                if (!template) return;

                this.editingTemplateId = templateId;
                document.getElementById('templateName').value = template.name;
                document.getElementById('templateDescription').value = template.description || '';
                this.currentDimensions = [...template.dimensions];
                this.renderDimensions();

                if (template.aiScoringConfig?.enabled) {
                    document.getElementById('enableAiScoring').checked = true;
                    document.getElementById('aiScoringConfig').style.display = 'block';
                    document.getElementById('judgeModelSelect').value = template.aiScoringConfig.judgeModelId || '';
                    document.getElementById('promptTemplate').value = template.aiScoringConfig.promptTemplate || '';
                }

                window.scrollTo({ top: 0, behavior: 'smooth' });
                showToast('æ¨¡æ¿å·²åŠ è½½åˆ°ç¼–è¾‘åŒº', 'info');
            }

            deleteTemplate(templateId) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯„æµ‹æ¨¡æ¿å—ï¼Ÿ')) return;

                Storage.deleteEvaluationTemplate(templateId);
                this.loadTemplates();
                showToast('æ¨¡æ¿å·²åˆ é™¤', 'info');
            }

            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            formatDate(isoString) {
                const date = new Date(isoString);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }

        // åˆå§‹åŒ–
        window.evalConfigManager = new EvaluationConfigManager();
    </script>
</body>
</html>
